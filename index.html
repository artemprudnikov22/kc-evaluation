<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–µ—Ä–≤–∏—Å AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ—Ü–µ–Ω–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–∞</title>
<style>
body {
margin: 0;
font-family: "Inter", Arial, sans-serif;
background: #FFFFFF;
color: #353333;
padding: 20px;
}

.header {
display: flex;
align-items: center;
gap: 16px;
margin-bottom: 20px;
}

.header img {
height: 48px;
}

.department-title {
font-size: 22px;
font-weight: 700;
color: #642D90;
}

.add-employee-btn {
background: #ECB144;
color: #353333;
padding: 12px 20px;
border-radius: 10px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
border: none;
margin-bottom: 5px;
width: 100%;
}

.security-note {
font-size: 13px;
color: #666;
margin-top: 0;
margin-bottom: 20px;
text-align: center;
}

.security-note span {
    color: #ff4444;
    font-weight: 600;
}

.employee-card {
background: #FFFFFF;
border-radius: 14px;
box-shadow: 0 4px 12px rgba(100,45,144,0.15);
padding: 16px 20px;
margin-bottom: 16px;
}

.emp-name {
font-size: 18px;
font-weight: 600;
margin-bottom: 4px;
cursor: pointer;
display: inline-block;
border-bottom: 1px dashed #642D90;
}

.emp-name:hover {
color: #642D90;
}

.emp-top {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 8px;
}

.emp-info {
margin-bottom: 10px;
}

.button {
background: #642D90;
color: #FFFFFF;
padding: 10px 16px;
border-radius: 10px;
text-decoration: none;
font-weight: 600;
cursor: pointer;
display: inline-block;
margin-top: 10px;
border: none;
}

.upload-button {
background: #ECB144;
color: #353333;
padding: 6px 12px;
border-radius: 10px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: 0.2s;
user-select: none;
}

.upload-button:hover {
background: #d59d3c;
}

.details {
margin-top: 12px;
background: #F8F5FC;
padding: 12px;
border-radius: 10px;
border-left: 4px solid #ECB144;
}

.date-link {
color: #642D90;
cursor: pointer;
text-decoration: underline;
font-weight: 600;
}

.date-link:hover {
color: #ECB144;
}

.analysis-detail {
background: white;
padding: 12px;
margin: 10px 0;
border-radius: 8px;
border-left: 3px solid #642D90;
}

.dialog-item {
padding: 8px;
background: #f9f9f9;
margin: 6px 0;
border-radius: 6px;
font-size: 13px;
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 1000;
overflow-y: auto;
}

.modal-content {
background: white;
margin: 50px auto;
padding: 20px;
border-radius: 14px;
max-width: 600px;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.modal-input {
width: 100%;
padding: 10px;
margin: 10px 0;
border: 2px solid #642D90;
border-radius: 8px;
font-size: 14px;
box-sizing: border-box;
}

.modal-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
}

.modal-btn {
flex: 1;
padding: 10px;
border: none;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
}

.modal-btn-save {
background: #642D90;
color: white;
}

.modal-btn-cancel {
background: #ddd;
color: #333;
}

.loader {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: white;
padding: 30px;
border-radius: 14px;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
z-index: 2000;
text-align: center;
min-width: 300px;
}

.loader-backdrop {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 1999;
}

.spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid #642D90;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 0 auto 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div class="header">
<img src="logo.png">
<div class="department-title">–°–µ—Ä–≤–∏—Å AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ—Ü–µ–Ω–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–∞</div>
</div>

<button class="add-employee-btn" onclick="openAddEmployeeModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
<div class="security-note">* –í —Ü–µ–ª—è—Ö —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ <span>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</span>.</div>
<div id="content"></div>

<div class="loader-backdrop" id="loaderBackdrop"></div>
<div class="loader" id="loader">
<div class="spinner"></div>
<div id="loaderText">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</div>
</div>

<div id="addEmployeeModal" class="modal">
<div class="modal-content">
<h3 style="margin-top: 0;">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
<input type="text" id="newEmpName" class="modal-input" placeholder="–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
<input type="text" id="newEmpPosition" class="modal-input" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
<div class="modal-buttons">
<button class="modal-btn modal-btn-save" onclick="saveNewEmployee()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="modal-btn modal-btn-cancel" onclick="closeAddEmployeeModal()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>
</div>

<div id="analysisModal" class="modal">
<div class="modal-content">
<h3 id="analysisTitle"></h3>
<div id="analysisContent"></div>
<div class="modal-buttons">
<button class="modal-btn modal-btn-cancel" onclick="closeAnalysisModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
</div>

<script>
// ‚úÖ N8N WEBHOOK URLs
const N8N_BASE_URL = 'https://n8n.decartus.team';
const UPLOAD_DIALOGS_URL = `${N8N_BASE_URL}/webhook/upload-dialogs`;
const SYNC_EMPLOYEES_URL = `${N8N_BASE_URL}/webhook/sync-employees`;
const GET_EMPLOYEES_URL = `${N8N_BASE_URL}/webhook/get-employees`;
const GET_ANALYSIS_URL = `${N8N_BASE_URL}/webhook/get-analyzed-dialogs`;

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
let employees = [];
let analysisData = {};
let nextEmployeeId = 106;

function showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
document.getElementById('loaderText').innerHTML = text;
document.getElementById('loader').style.display = 'block';
document.getElementById('loaderBackdrop').style.display = 'block';
}

function hideLoader() {
document.getElementById('loader').style.display = 'none';
document.getElementById('loaderBackdrop').style.display = 'none';
}

// ‚úÖ –ó–ê–ì–†–£–ó–ö–ê –°–û–¢–†–£–î–ù–ò–ö–û–í –ò–ó N8N
async function loadEmployees() {
try {
console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ N8N...');

const response = await fetch(GET_EMPLOYEES_URL, {
method: 'GET',
headers: {
'Content-Type': 'application/json'
}
});

if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}

const rows = await response.json();
console.log('üë• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', rows);

if (Array.isArray(rows) && rows.length > 0) {
employees = rows.map(row => ({
    id: parseInt(row.employee_id),
    name: row.name,
    position: row.position,
    expanded: false
}));

nextEmployeeId = Math.max(...employees.map(e => e.id)) + 1;
} else {
employees = [];
nextEmployeeId = 101;
}

console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', employees);

} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
hideLoader();
employees = [];
nextEmployeeId = 101;
}
}

// ‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ê–ù–ê–õ–ò–ó–û–í –ß–ï–†–ï–ó WEBHOOK
async function loadAnalysisData() {
try {
console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã —á–µ—Ä–µ–∑ webhook...');

const response = await fetch(GET_ANALYSIS_URL, {
method: 'GET',
headers: {
'Content-Type': 'application/json'
}
});

if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}

const rows = await response.json();
console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ –∞–Ω–∞–ª–∏–∑–æ–≤:', rows);

analysisData = {};

if (Array.isArray(rows)) {
rows.forEach(row => {
const empId = parseInt(row.employee_id);
if (!analysisData[empId]) {
analysisData[empId] = [];
}
analysisData[empId].push({
date: row.analyzed_at,
dialogsCount: row.dialogs_count,
dialogIds: row.dialog_ids || '',
complexityLevel: row.complexity_level,
ierCoefficient: row.ier_coefficient,
justification: row.justification
});
});
}

console.log('‚úÖ –ê–Ω–∞–ª–∏–∑—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã:', analysisData);

} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤:', error);
hideLoader();
}
}

// ‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –°–û–¢–†–£–î–ù–ò–ö–û–í –° N8N
async function syncEmployeesToDB() {
try {
const employeesData = employees.map(emp => ({
id: emp.id,
name: emp.name,
position: emp.position,
summary: {
final_score: 0,
final_grade: "N/A",
last_score: 0,
last_grade: "N/A",
last_review_date: ""
},
details: {
data: {
grade_history: [],
review_details: []
}
}
}));

const response = await fetch(SYNC_EMPLOYEES_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ employees: employeesData })
});

if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}

console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ë–î');

} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
}
}

// ‚úÖ –†–ê–°–ß–ï–¢ –°–†–ï–î–ù–ï–ì–û –ò–≠–†
function calculateAverageIER(employeeId) {
const analyses = analysisData[employeeId] || [];
if (analyses.length === 0) return 0;

const sum = analyses.reduce((acc, a) => acc + parseFloat(a.ierCoefficient || 0), 0);
return (sum / analyses.length).toFixed(2);
}

// ‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–°–õ–ï–î–ù–ò–ô –ò–≠–†
function getLastIER(employeeId) {
const analyses = analysisData[employeeId] || [];
if (analyses.length === 0) return { ier: 0, date: '‚Äî' };

const sorted = analyses.sort((a, b) => new Date(b.date) - new Date(a.date));
return {
ier: sorted[0].ierCoefficient,
date: new Date(sorted[0].date).toLocaleDateString('ru-RU')
};
}

// ‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–¢–û–†–ò–Æ –û–¶–ï–ù–û–ö
function getAnalysisHistory(employeeId) {
const analyses = analysisData[employeeId] || [];
return analyses.sort((a, b) => new Date(b.date) - new Date(a.date));
}

// ‚úÖ –ü–û–ö–ê–ó–ê–¢–¨ –î–ï–¢–ê–õ–ò –ê–ù–ê–õ–ò–ó–ê
function showAnalysisDetails(employeeId, analysisDate) {
const analyses = analysisData[employeeId] || [];
const analysis = analyses.find(a => a.date === analysisDate);

if (!analysis) {
alert('–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
return;
}

const modal = document.getElementById('analysisModal');
const title = document.getElementById('analysisTitle');
const content = document.getElementById('analysisContent');

const employee = employees.find(e => e.id === employeeId);
const dateStr = new Date(analysis.date).toLocaleDateString('ru-RU', {
year: 'numeric',
month: 'long',
day: 'numeric',
hour: '2-digit',
minute: '2-digit'
});

title.innerText = `ü§ñ AI-–ê–Ω–∞–ª–∏–∑: ${employee.name} ‚Äî ${dateStr}`;

let html = `
<div class="analysis-detail">
<b>üìä –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${analysis.ierCoefficient}<br>
<b>üìà –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</b> ${analysis.complexityLevel}<br>
<b>üìÅ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤:</b> ${analysis.dialogsCount}<br><br>

<b>üí¨ –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</b><br>
<p style="background: #f9f9f9; padding: 10px; border-radius: 6px;">${analysis.justification}</p><br>
`;

if (analysis.dialogIds) {
html += `<b>üìã –î–∏–∞–ª–æ–≥–∏:</b><br>`;
const dialogIds = analysis.dialogIds.toString().split(',').map(id => id.trim());
dialogIds.forEach((dialogId, index) => {
html += `<div class="dialog-item">üìÑ –î–∏–∞–ª–æ–≥ #${index + 1} (ID: ${dialogId})</div>`;
});
}

html += `</div>`;

content.innerHTML = html;
modal.style.display = 'block';
}

function closeAnalysisModal() {
document.getElementById('analysisModal').style.display = 'none';
}

// ‚úÖ –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–û–í
async function handleUpload(event, employeeId) {
const file = event.target.files[0];
if (!file) return;

console.log('='.repeat(60));
console.log('=== –ù–ê–ß–ê–õ–û –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–ê ===');
console.log('='.repeat(60));
console.log('üìÅ –ò–º—è —Ñ–∞–π–ª–∞:', file.name);
console.log('üìä –†–∞–∑–º–µ—Ä (–±–∞–π—Ç):', file.size);
console.log('üìä –†–∞–∑–º–µ—Ä (–ú–ë):', (file.size / 1024 / 1024).toFixed(2));
console.log('üìÑ –¢–∏–ø MIME:', file.type);
console.log('üìÖ –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è:', new Date(file.lastModified).toLocaleString('ru-RU'));

const employee = employees.find(e => e.id === employeeId);
const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);

// –ü–†–û–í–ï–†–ö–ê: –ú–æ–∂–µ—Ç –ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª?
console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞...');
try {
const arrayBuffer = await file.arrayBuffer();
console.log('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º');
console.log('üì¶ –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞:', arrayBuffer.byteLength, '–±–∞–π—Ç');
} catch (readError) {
console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –§–∞–π–ª –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è!', readError);
hideLoader();
alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª:\n${readError.message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.`);
event.target.value = '';
return;
}

console.log('üë§ Employee ID:', employeeId);
console.log('üë§ Employee Name:', employee.name);
console.log('üéØ URL –∑–∞–≥—Ä—É–∑–∫–∏:', UPLOAD_DIALOGS_URL);

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
if (file.size > 1024 * 1024 * 1.5) {
const confirm = window.confirm(
    `‚ö†Ô∏è –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª (${fileSizeMB} –ú–ë)\n\n` +
    `–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5-10 –º–∏–Ω—É—Ç.\n` +
    `–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É!\n\n` +
    `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É?`
);

if (!confirm) {
    console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –∑–∞–≥—Ä—É–∑–∫—É –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞');
    event.target.value = '';
    return;
}
}

const formData = new FormData();
formData.append('file', file);
formData.append('employeeId', employeeId);
formData.append('employeeName', employee.name);

console.log('üì¶ FormData —Å–æ–∑–¥–∞–Ω —Å –ø–æ–ª—è–º–∏:');
console.log('   - file:', file.name);
console.log('   - employeeId:', employeeId);
console.log('   - employeeName:', employee.name);

showLoader(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ "${file.name}"<br>(${fileSizeMB} –ú–ë)...<br><br>‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 10 –º–∏–Ω—É—Ç.<br>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É!`);

try {
console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ XMLHttpRequest...');

const xhr = new XMLHttpRequest();
const startTime = Date.now();

const uploadPromise = new Promise((resolve, reject) => {
    
    // –°–æ–±—ã—Ç–∏–µ: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    xhr.addEventListener('loadstart', () => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`üîå [${elapsed}—Å] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö...`);
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
    xhr.upload.addEventListener('progress', (e) => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
            const totalMB = (e.total / 1024 / 1024).toFixed(2);
            const speed = (e.loaded / 1024 / (Date.now() - startTime)).toFixed(2);
            
            console.log(`üì§ [${elapsed}—Å] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${percent}% (${loadedMB} / ${totalMB} –ú–ë) | –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –ö–ë/—Å`);
            
            document.getElementById('loaderText').innerHTML = 
                `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${percent}%<br>(${loadedMB} / ${totalMB} –ú–ë)<br><br>‚è≥ –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É!`;
        } else {
            console.log(`üì§ [${elapsed}—Å] –ó–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç... (—Ä–∞–∑–º–µ—Ä –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω)`);
        }
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç
    xhr.upload.addEventListener('load', () => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`‚úÖ [${elapsed}—Å] –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –æ–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç–∞...`);
        document.getElementById('loaderText').innerHTML = 
            `–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!<br><br>ü§ñ AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥–∏...<br>‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.`;
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    xhr.addEventListener('load', () => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`üì• [${elapsed}—Å] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞`);
        console.log('üìä HTTP –°—Ç–∞—Ç—É—Å:', xhr.status, xhr.statusText);
        console.log('üìù –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', xhr.getAllResponseHeaders());
        console.log('üìÑ –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):', xhr.responseText.substring(0, 500));
        
        if (xhr.status >= 200 && xhr.status < 300) {
            try {
                const result = JSON.parse(xhr.responseText);
                console.log('‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω:', result);
                resolve(result);
            } catch (e) {
                console.log('‚ö†Ô∏è –û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON, –ø—Ä–∏–Ω–∏–º–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç');
                resolve({ success: true, message: xhr.responseText });
            }
        } else {
            console.error(`‚ùå –û—à–∏–±–∫–∞ HTTP ${xhr.status}`);
            reject(new Error(`HTTP ${xhr.status}: ${xhr.responseText.substring(0, 200)}`));
        }
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
    xhr.addEventListener('error', (e) => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.error(`üí• [${elapsed}—Å] –û–®–ò–ë–ö–ê –°–ï–¢–ò!`);
        console.error('Event:', e);
        console.error('ReadyState:', xhr.readyState);
        console.error('Status:', xhr.status);
        console.error('StatusText:', xhr.statusText);
        
        reject(new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: 1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É 2) –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å n8n.decartus.team 3) –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'));
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –¢–∞–π–º–∞—É—Ç
    xhr.timeout = 900000; // 15 –º–∏–Ω—É—Ç
    xhr.addEventListener('timeout', () => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.error(`‚è±Ô∏è [${elapsed}—Å] –¢–ê–ô–ú–ê–£–¢! –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª 15 –º–∏–Ω—É—Ç`);
        reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (15 –º–∏–Ω—É—Ç). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.'));
    });
    
    // –°–æ–±—ã—Ç–∏–µ: –ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω
    xhr.addEventListener('abort', () => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        console.error(`üö´ [${elapsed}—Å] –ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º`);
        reject(new Error('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞'));
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    console.log('üì° –û—Ç–∫—Ä—ã–≤–∞–µ–º POST —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å:', UPLOAD_DIALOGS_URL);
    xhr.open('POST', UPLOAD_DIALOGS_URL);
    
    console.log('üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º FormData...');
    xhr.send(formData);
    console.log('‚úÖ send() –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–π...');
});

const result = await uploadPromise;

const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
console.log('='.repeat(60));
console.log(`‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û (${totalTime}—Å)`);
console.log('='.repeat(60));
console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);

hideLoader();

alert(`‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${employee.name}\n–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤: ${result.total || result.processed || '–î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è'}\n–í—Ä–µ–º—è: ${totalTime}—Å`);

// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
setTimeout(async () => {
    showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
    await loadAnalysisData();
    render();
    hideLoader();
}, 3000);

} catch (error) {
hideLoader();

const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
console.log('='.repeat(60));
console.error(`‚ùå –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –° –û–®–ò–ë–ö–û–ô (${totalTime}—Å)`);
console.log('='.repeat(60));
console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
console.error('Stack:', error.stack);

if (error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
    alert(
        `‚è±Ô∏è ${error.message}\n\n` +
        `–§–∞–π–ª: ${file.name}\n` +
        `–†–∞–∑–º–µ—Ä: ${fileSizeMB} –ú–ë\n` +
        `–í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: ${totalTime}—Å\n\n` +
        `üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n` +
        `‚Ä¢ –†–∞–∑–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –º–µ–Ω—å—à–∏–µ —á–∞—Å—Ç–∏\n` +
        `‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å n8n Executions\n` +
        `‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç—å batchSize –≤ workflow`
    );
} else if (error.message.includes('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏')) {
    alert(
        `‚ùå ${error.message}\n\n` +
        `–§–∞–π–ª: ${file.name}\n` +
        `–í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: ${totalTime}—Å\n\n` +
        `–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –ª–æ–≥–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É!`
    );
} else {
    alert(
        `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:\n\n${error.message}\n\n` +
        `–í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: ${totalTime}—Å\n\n` +
        `–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–æ–ª–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π.`
    );
}
}

event.target.value = '';
}

async function editEmployeeName(employeeId, currentName) {
const employee = employees.find(e => e.id === employeeId);
if (!employee) return;

const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:", currentName);
if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
employee.name = newName.trim();
render();
await syncEmployeesToDB();
}
}

function openAddEmployeeModal() {
document.getElementById('addEmployeeModal').style.display = 'block';
document.getElementById('newEmpName').value = '';
document.getElementById('newEmpPosition').value = '';
}

function closeAddEmployeeModal() {
document.getElementById('addEmployeeModal').style.display = 'none';
}

async function saveNewEmployee() {
const name = document.getElementById('newEmpName').value.trim();
const position = document.getElementById('newEmpPosition').value.trim();

if (!name || !position) {
alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
return;
}

const newEmployee = {
id: nextEmployeeId++,
name: name,
position: position,
expanded: false
};

employees.push(newEmployee);
closeAddEmployeeModal();
render();

await syncEmployeesToDB();
}

function render() {
const wrapper = document.getElementById("content");
wrapper.innerHTML = "";

const dept = document.createElement("h2");
dept.innerText = "–û—Ç–¥–µ–ª: –ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä";
wrapper.appendChild(dept);

employees.forEach(emp => {
const card = document.createElement("div");
card.className = "employee-card";

const avgIER = calculateAverageIER(emp.id);
const lastIER = getLastIER(emp.id);
const history = getAnalysisHistory(emp.id);

card.innerHTML = `
<div class="emp-top">
<div class="emp-name" onclick="editEmployeeName(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')">${emp.name} ‚úèÔ∏è</div>

<div>
<label class="upload-button">
üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏
<input type="file" style="display:none" accept=".txt,.json,.csv,.xlsx,.xls,.xml,.docx,.doc,.pdf" onchange="handleUpload(event, ${emp.id})">
</label>
</div>
</div>

<div class="emp-info">
–î–æ–ª–∂–Ω–æ—Å—Ç—å: ${emp.position}<br>
<b>üéØ –ò—Ç–æ–≥–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${avgIER || '‚Äî'}<br>
<b>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${lastIER.ier || '‚Äî'}<br>
–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏: ${lastIER.date}
</div>
`;

const btn = document.createElement("div");
btn.className = "button";
btn.innerText = emp.expanded ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–¥—Ä–æ–±–Ω–µ–µ";
btn.onclick = () => {
emp.expanded = !emp.expanded;
render();
};
card.appendChild(btn);

if (emp.expanded) {
const det = document.createElement("div");
det.className = "details";

if (history.length > 0) {
det.innerHTML = `<b>üìÖ –ò—Å—Ç–æ—Ä–∏—è –æ—Ü–µ–Ω–æ–∫ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π):</b><br><br>`;

history.forEach(h => {
const dateStr = new Date(h.date).toLocaleDateString('ru-RU');
det.innerHTML += `
<span class="date-link" onclick="showAnalysisDetails(${emp.id}, '${h.date}')">
üìÖ ${dateStr}
</span> ‚Äî <b>–ò–≠–†: ${h.ierCoefficient}</b> (–î–∏–∞–ª–æ–≥–æ–≤: ${h.dialogsCount}, –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${h.complexityLevel})<br>
`;
});
} else {
det.innerHTML = `<i>–î–∞–Ω–Ω—ã–µ –ø–æ –∞–Ω–∞–ª–∏–∑—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ AI-–∞–Ω–∞–ª–∏–∑–∞.</i>`;
}

card.appendChild(det);
}

wrapper.appendChild(card);
});
}

window.onclick = function(event) {
const addModal = document.getElementById('addEmployeeModal');
const analysisModal = document.getElementById('analysisModal');

if (event.target === addModal) {
closeAddEmployeeModal();
}
if (event.target === analysisModal) {
closeAnalysisModal();
}
}

// ‚úÖ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
async function init() {
showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã...');

await loadEmployees();
await loadAnalysisData();

hideLoader();
render();
}

init();
</script>

</body>
</html>
