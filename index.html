<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–µ–≤—Å—Ç–∞—Ä ‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>
<style>
    body {
        margin: 0;
        font-family: "Inter", Arial, sans-serif;
        background: #FFFFFF;
        color: #353333;
        padding: 20px;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }

    .header img {
        height: 48px;
    }

    .department-title {
        font-size: 22px;
        font-weight: 700;
        color: #642D90;
    }

    .add-employee-btn {
        background: #ECB144;
        color: #353333;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        margin-bottom: 20px;
        width: 100%;
    }

    .save-db-btn {
        background: #642D90;
        color: white;
    }

    .employee-card {
        background: #FFFFFF;
        border-radius: 14px;
        box-shadow: 0 4px 12px rgba(100,45,144,0.15);
        padding: 16px 20px;
        margin-bottom: 16px;
    }

    .emp-name {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
        cursor: pointer;
        display: inline-block;
        border-bottom: 1px dashed #642D90;
    }

    .emp-name:hover {
        color: #642D90;
    }

    .emp-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .emp-info {
        margin-bottom: 10px;
    }

    .button {
        background: #642D90;
        color: #FFFFFF;
        padding: 10px 16px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-block;
        margin-top: 10px;
        border: none;
    }

    .upload-button {
        background: #ECB144;
        color: #353333;
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        user-select: none;
    }

    .upload-button:hover {
        background: #d59d3c;
    }

    .delete-btn {
        background: #ff4444;
        color: white;
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        margin-left: 8px;
    }

    .details {
        margin-top: 12px;
        background: #F8F5FC;
        padding: 12px;
        border-radius: 10px;
        border-left: 4px solid #ECB144;
    }

    .date-link {
        color: #642D90;
        cursor: pointer;
        text-decoration: underline;
        font-weight: 600;
    }

    .date-link:hover {
        color: #ECB144;
    }

    .analysis-detail {
        background: white;
        padding: 12px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 3px solid #642D90;
    }

    .dialog-item {
        padding: 8px;
        background: #f9f9f9;
        margin: 6px 0;
        border-radius: 6px;
        font-size: 13px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        background: white;
        margin: 50px auto;
        padding: 20px;
        border-radius: 14px;
        max-width: 600px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .modal-input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 2px solid #642D90;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .modal-btn-save {
        background: #642D90;
        color: white;
    }

    .modal-btn-cancel {
        background: #ddd;
        color: #333;
    }

    .loader {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 14px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 2000;
        text-align: center;
    }

    .loader-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #642D90;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
</head>

<body>

<div class="header">
    <img src="logo.png">
    <div class="department-title">–°–µ–≤—Å—Ç–∞—Ä ‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
</div>

<button class="add-employee-btn" onclick="openAddEmployeeModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>

<button class="add-employee-btn save-db-btn" onclick="saveToDatabase()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –ö–¶</button>

<div id="content"></div>

<div class="loader-backdrop" id="loaderBackdrop"></div>
<div class="loader" id="loader">
    <div class="spinner"></div>
    <div id="loaderText">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
<div id="addEmployeeModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top: 0;">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
        <input type="text" id="newEmpName" class="modal-input" placeholder="–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
        <input type="text" id="newEmpPosition" class="modal-input" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-save" onclick="saveNewEmployee()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="modal-btn modal-btn-cancel" onclick="closeAddEmployeeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞ -->
<div id="analysisModal" class="modal">
    <div class="modal-content">
        <h3 id="analysisTitle"></h3>
        <div id="analysisContent"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeAnalysisModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
// ‚úÖ N8N WEBHOOK URLs
const N8N_BASE_URL = 'https://n8n.decartus.team';
const UPLOAD_DIALOGS_URL = `${N8N_BASE_URL}/webhook/upload-dialogs`;
const SYNC_EMPLOYEES_URL = `${N8N_BASE_URL}/webhook/sync-employees`;
const GET_ANALYSIS_URL = `${N8N_BASE_URL}/webhook/get-analyzed-dialogs`;

const STORAGE_KEY = 'sevstar_employees_data';

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–Ω–∞–ª–∏–∑–æ–≤
let analysisData = {};

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            return getDefaultData();
        }
    }
    return getDefaultData();
}

function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
}

function getDefaultData() {
    return {
        "department": {
            "id": 1,
            "name": "–û—Ç–¥–µ–ª: –ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä",
            "employees": [
                {
                    "id": 101,
                    "name": "–ò–≤–∞–Ω–æ–≤ –í–∞—Å—è",
                    "position": "–û–ø–µ—Ä–∞—Ç–æ—Ä"
                },
                {
                    "id": 102,
                    "name": "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞",
                    "position": "–°—Ç–∞—Ä—à–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä"
                }
            ]
        }
    };
}

let data = loadData();
let nextEmployeeId = Math.max(...data.department.employees.map(e => e.id)) + 1;

function showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    document.getElementById('loaderText').innerText = text;
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loaderBackdrop').style.display = 'block';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('loaderBackdrop').style.display = 'none';
}

// ‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ê–ù–ê–õ–ò–ó–û–í –ß–ï–†–ï–ó WEBHOOK
async function loadAnalysisData() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã —á–µ—Ä–µ–∑ webhook...');
        
        const response = await fetch(GET_ANALYSIS_URL, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const rows = await response.json();
        
        console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ –∞–Ω–∞–ª–∏–∑–æ–≤:', rows);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ employee_id
        analysisData = {};
        
        if (Array.isArray(rows)) {
            rows.forEach(row => {
                const empId = parseInt(row.employee_id);
                if (!analysisData[empId]) {
                    analysisData[empId] = [];
                }
                analysisData[empId].push({
                    date: row.analyzed_at,
                    dialogsCount: row.dialogs_count,
                    dialogIds: row.dialog_ids || '',
                    complexityLevel: row.complexity_level,
                    ierCoefficient: row.ier_coefficient,
                    justification: row.justification
                });
            });
        }

        console.log('‚úÖ –ê–Ω–∞–ª–∏–∑—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã:', analysisData);
        render();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤:', error);
        render();
    }
}

// ‚úÖ –†–ê–°–ß–ï–¢ –°–†–ï–î–ù–ï–ì–û –ò–≠–†
function calculateAverageIER(employeeId) {
    const analyses = analysisData[employeeId] || [];
    if (analyses.length === 0) return 0;
    
    const sum = analyses.reduce((acc, a) => acc + parseFloat(a.ierCoefficient || 0), 0);
    return (sum / analyses.length).toFixed(2);
}

// ‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–°–õ–ï–î–ù–ò–ô –ò–≠–†
function getLastIER(employeeId) {
    const analyses = analysisData[employeeId] || [];
    if (analyses.length === 0) return { ier: 0, date: '‚Äî' };
    
    const sorted = analyses.sort((a, b) => new Date(b.date) - new Date(a.date));
    return {
        ier: sorted[0].ierCoefficient,
        date: new Date(sorted[0].date).toLocaleDateString('ru-RU')
    };
}

// ‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–¢–û–†–ò–Æ –û–¶–ï–ù–û–ö
function getAnalysisHistory(employeeId) {
    const analyses = analysisData[employeeId] || [];
    return analyses.sort((a, b) => new Date(b.date) - new Date(a.date));
}

// ‚úÖ –ü–û–ö–ê–ó–ê–¢–¨ –î–ï–¢–ê–õ–ò –ê–ù–ê–õ–ò–ó–ê
function showAnalysisDetails(employeeId, analysisDate) {
    const analyses = analysisData[employeeId] || [];
    const analysis = analyses.find(a => a.date === analysisDate);
    
    if (!analysis) {
        alert('–ê–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    const modal = document.getElementById('analysisModal');
    const title = document.getElementById('analysisTitle');
    const content = document.getElementById('analysisContent');

    const employee = data.department.employees.find(e => e.id === employeeId);
    const dateStr = new Date(analysis.date).toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    title.innerText = `ü§ñ AI-–ê–Ω–∞–ª–∏–∑: ${employee.name} ‚Äî ${dateStr}`;

    let html = `
        <div class="analysis-detail">
            <b>üìä –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${analysis.ierCoefficient}<br>
            <b>üìà –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</b> ${analysis.complexityLevel}<br>
            <b>üìÅ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤:</b> ${analysis.dialogsCount}<br><br>
            
            <b>üí¨ –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</b><br>
            <p style="background: #f9f9f9; padding: 10px; border-radius: 6px;">${analysis.justification}</p><br>
    `;

    if (analysis.dialogIds) {
        html += `<b>üìã –î–∏–∞–ª–æ–≥–∏:</b><br>`;
        const dialogIds = analysis.dialogIds.toString().split(',').map(id => id.trim());
        dialogIds.forEach((dialogId, index) => {
            html += `<div class="dialog-item">üìÑ –î–∏–∞–ª–æ–≥ #${index + 1} (ID: ${dialogId})</div>`;
        });
    }

    html += `</div>`;

    content.innerHTML = html;
    modal.style.display = 'block';
}

function closeAnalysisModal() {
    document.getElementById('analysisModal').style.display = 'none';
}

// ‚úÖ –ó–ê–ì–†–£–ó–ö–ê –î–ò–ê–õ–û–ì–û–í (–° –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï–ú!)
async function handleUpload(event, employeeId) {
    const file = event.target.files[0];
    if (!file) return;

    const employee = data.department.employees.find(e => e.id === employeeId);
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('employeeId', employeeId);
    formData.append('employeeName', employee.name);

    showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –∏ AI-–∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤...');

    try {
        const response = await fetch(UPLOAD_DIALOGS_URL, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        hideLoader();
        
        alert(`‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${employee.name}\n–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤: ${result.total || result.processed || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ N8N'}`);
        
        // ‚ö° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –û–ë–ù–û–í–õ–Ø–ï–ú –ê–ù–ê–õ–ò–ó–´ –° –ó–ê–î–ï–†–ñ–ö–û–ô
        setTimeout(async () => {
            await loadAnalysisData();
        }, 2000);
        
    } catch (error) {
        hideLoader();
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:\n${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
        console.error('üí• Upload error:', error);
    }

    event.target.value = '';
}

// ‚úÖ –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î
async function saveToDatabase() {
    const employees = data.department.employees.map(emp => ({
        id: emp.id,
        name: emp.name,
        position: emp.position
    }));

    showLoader('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î...');

    try {
        const response = await fetch(SYNC_EMPLOYEES_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ employees })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        hideLoader();
        alert(`‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î!\n\n–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${employees.length}`);
        
    } catch (error) {
        hideLoader();
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:\n${error.message}`);
        console.error('üí• Save error:', error);
    }
}

function editEmployeeName(employeeId, currentName) {
    const employee = data.department.employees.find(e => e.id === employeeId);
    if (!employee) return;

    const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:", currentName);
    if (newName && newName.trim() !== "") {
        employee.name = newName.trim();
        saveData();
        render();
    }
}

function deleteEmployee(employeeId) {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) return;
    
    const index = data.department.employees.findIndex(e => e.id === employeeId);
    if (index !== -1) {
        data.department.employees.splice(index, 1);
        saveData();
        render();
    }
}

function openAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'block';
    document.getElementById('newEmpName').value = '';
    document.getElementById('newEmpPosition').value = '';
}

function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'none';
}

function saveNewEmployee() {
    const name = document.getElementById('newEmpName').value.trim();
    const position = document.getElementById('newEmpPosition').value.trim();
    
    if (!name || !position) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
        return;
    }

    const newEmployee = {
        "id": nextEmployeeId++,
        "name": name,
        "position": position
    };

    data.department.employees.push(newEmployee);
    saveData();
    closeAddEmployeeModal();
    render();
}

function render() {
    const wrapper = document.getElementById("content");
    wrapper.innerHTML = "";

    const dept = document.createElement("h2");
    dept.innerText = data.department.name;
    wrapper.appendChild(dept);

    data.department.employees.forEach(emp => {
        const card = document.createElement("div");
        card.className = "employee-card";

        const avgIER = calculateAverageIER(emp.id);
        const lastIER = getLastIER(emp.id);
        const history = getAnalysisHistory(emp.id);

        card.innerHTML = `
            <div class="emp-top">
                <div class="emp-name" onclick="editEmployeeName(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')">${emp.name}‚úèÔ∏è</div>

                <div>
                    <label class="upload-button">
                        üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏
                        <input type="file" style="display:none" accept=".txt,.json,.csv,.xlsx,.xls,.xml,.docx,.doc,.pdf" onchange="handleUpload(event, ${emp.id})">
                    </label>
                    <button class="delete-btn" onclick="deleteEmployee(${emp.id})">üóëÔ∏è</button>
                </div>
            </div>

            <div class="emp-info">
                –î–æ–ª–∂–Ω–æ—Å—Ç—å: ${emp.position}<br>
                <b>üéØ –ò—Ç–æ–≥–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${avgIER || '‚Äî'}<br>
                <b>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ò–≠–†:</b> ${lastIER.ier || '‚Äî'}<br>
                –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏: ${lastIER.date}
            </div>
        `;

        const btn = document.createElement("div");
        btn.className = "button";
        btn.innerText = emp.expanded ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–¥—Ä–æ–±–Ω–µ–µ";
        btn.onclick = () => {
            emp.expanded = !emp.expanded;
            render();
        };
        card.appendChild(btn);

        if (emp.expanded) {
            const det = document.createElement("div");
            det.className = "details";

            if (history.length > 0) {
                det.innerHTML = `<b>üìÖ –ò—Å—Ç–æ—Ä–∏—è –æ—Ü–µ–Ω–æ–∫ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π):</b><br><br>`;

                history.forEach(h => {
                    const dateStr = new Date(h.date).toLocaleDateString('ru-RU');
                    det.innerHTML += `
                        <span class="date-link" onclick="showAnalysisDetails(${emp.id}, '${h.date}')">
                            üìÖ ${dateStr}
                        </span> ‚Äî <b>–ò–≠–†: ${h.ierCoefficient}</b> (–î–∏–∞–ª–æ–≥–æ–≤: ${h.dialogsCount}, –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${h.complexityLevel})<br>
                    `;
                });
            } else {
                det.innerHTML = `<i>–î–∞–Ω–Ω—ã–µ –ø–æ –∞–Ω–∞–ª–∏–∑—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ AI-–∞–Ω–∞–ª–∏–∑–∞.</i>`;
            }

            card.appendChild(det);
        }

        wrapper.appendChild(card);
    });
}

window.onclick = function(event) {
    const addModal = document.getElementById('addEmployeeModal');
    const analysisModal = document.getElementById('analysisModal');
    
    if (event.target === addModal) {
        closeAddEmployeeModal();
    }
    if (event.target === analysisModal) {
        closeAnalysisModal();
    }
}

// ‚úÖ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
loadAnalysisData();
</script>

</body>
</html>
