<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Сервис ИИ-аналитики колл-центра | СЕВСТАР</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
<div id="app"></div>

<script type="module">
// ============================================================================
// КОНФИГУРАЦИЯ
// ============================================================================
const CONFIG = {
  N8N_BASE_URL: 'https://n8n.decartus.team',
  UPLOAD_DIALOGS_URL: 'https://n8n.decartus.team/webhook/upload-dialogs',
  SYNC_EMPLOYEES_URL: 'https://n8n.decartus.team/webhook/sync-employees',
  GET_EMPLOYEES_URL: 'https://n8n.decartus.team/webhook/get-employees',
  GET_ANALYSIS_URL: 'https://n8n.decartus.team/webhook/get-analyzed-dialogs',
  AGGREGATION_TIME_WINDOW: 5 * 60 * 1000, // 5 минут
  MAX_FILE_SIZE_MB: 50,
  WARN_FILE_SIZE_MB: 10,
  SUPPORTED_FORMATS: '.txt,.json,.csv,.xlsx,.xls,.xml,.docx,.doc,.pdf'
};

// ============================================================================
// СТИЛИ
// ============================================================================
const STYLES = `
:root {
  --primary: #642D90;
  --primary-light: #7A46A8;
  --primary-dark: #4A2170;
  --accent: #ECB144;
  --accent-light: #F3C97A;
  --accent-dark: #D59D3C;
  --dark: #353333;
  --light: #FFFFFF;
  --gray-50: #F8F9FA;
  --gray-100: #F1F3F5;
  --gray-200: #E9ECEF;
  --gray-300: #DEE2E6;
  --gray-400: #CED4DA;
  --gray-500: #ADB5BD;
  --gray-600: #868E96;
  --gray-700: #495057;
  --gray-800: #343A40;
  --gray-900: #212529;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-sm: 0 2px 8px rgba(100, 45, 144, 0.08);
  --shadow-md: 0 4px 16px rgba(100, 45, 144, 0.12);
  --shadow-lg: 0 8px 32px rgba(100, 45, 144, 0.16);
  --shadow-xl: 0 16px 48px rgba(100, 45, 144, 0.2);
  --transition-fast: 150ms ease;
  --transition-base: 250ms ease;
  --transition-slow: 350ms ease;
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-mono: 'SF Mono', Monaco, 'Cascadia Mono', 'Segoe UI Mono', monospace;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-sans);
  background: linear-gradient(135deg, #F8F5FC 0%, #F0EBF9 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  padding: 0;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(100, 45, 144, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(100, 45, 144, 0); }
  100% { box-shadow: 0 0 0 0 rgba(100, 45, 144, 0); }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  animation: fadeIn var(--transition-slow);
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
  padding: 20px;
  background: var(--light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  animation: slideInRight var(--transition-base);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  height: 56px;
  width: auto;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.title-section h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.title-section p {
  font-size: 14px;
  color: var(--gray-600);
  font-weight: 500;
}

.stats-section {
  display: flex;
  gap: 24px;
  align-items: center;
}

.stat-item {
  text-align: right;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-label {
  font-size: 12px;
  color: var(--gray-600);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.main-content {
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;
}

.employee-cards-container {
  background: var(--light);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-md);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-title i {
  color: var(--primary);
  font-size: 24px;
}

.add-employee-btn {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
  color: var(--dark);
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-sm);
}

.add-employee-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.add-employee-btn:active {
  transform: translateY(0);
}

.security-note {
  font-size: 13px;
  color: var(--gray-600);
  text-align: center;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  margin-bottom: 20px;
  border-left: 4px solid var(--accent);
}

.security-note span {
  color: #FF4757;
  font-weight: 600;
}

.employee-card {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.employee-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-light);
}

.employee-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--primary-light));
  border-radius: var(--radius-sm) 0 0 var(--radius-sm);
}

.employee-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}

.employee-info h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 4px;
  cursor: pointer;
  display: inline-block;
  transition: color var(--transition-fast);
  padding-right: 24px;
  position: relative;
}

.employee-info h3:hover {
  color: var(--primary);
}

.employee-info h3::after {
  content: '✏️';
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.employee-info h3:hover::after {
  opacity: 1;
}

.employee-position {
  font-size: 14px;
  color: var(--gray-600);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.upload-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.upload-button {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--light);
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-sm);
}

.upload-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.upload-button:active {
  transform: translateY(0);
}

.file-input {
  display: none;
}

.file-types {
  font-size: 12px;
  color: var(--gray-500);
  text-align: right;
}

.employee-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  padding: 16px;
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
}

.stat-card:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
}

.stat-card-title {
  font-size: 12px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-card-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
}

.stat-card-subtitle {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 4px;
}

.details-toggle {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  width: 100%;
  justify-content: center;
  margin-top: 16px;
}

.details-toggle:hover {
  background: var(--primary);
  color: var(--light);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.employee-details {
  margin-top: 20px;
  padding: 20px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--accent);
  animation: fadeIn var(--transition-base);
}

.details-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.analysis-history {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.analysis-item {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 16px;
  border: 1px solid var(--gray-200);
  cursor: pointer;
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.analysis-item:hover {
  transform: translateX(4px);
  border-color: var(--primary-light);
  box-shadow: var(--shadow-sm);
}

.analysis-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 3px;
  background: var(--primary);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.analysis-item:hover::before {
  opacity: 1;
}

.analysis-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.analysis-date {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.analysis-stats {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: var(--gray-600);
}

.analysis-stat {
  display: flex;
  align-items: center;
  gap: 4px;
}

.analysis-summary {
  font-size: 13px;
  color: var(--gray-700);
  line-height: 1.5;
}

.no-data {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
  font-style: italic;
}

.no-data i {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
  color: var(--gray-400);
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.75);
  z-index: 1000;
  animation: fadeIn var(--transition-base);
  backdrop-filter: blur(8px);
}

.modal-content {
  background: var(--light);
  margin: 60px auto;
  padding: 0;
  border-radius: var(--radius-xl);
  max-width: 500px;
  width: 90%;
  box-shadow: var(--shadow-xl);
  animation: slideInRight var(--transition-base);
  overflow: hidden;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: var(--light);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
}

.close-btn {
  background: transparent;
  border: none;
  color: var(--light);
  font-size: 24px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background var(--transition-fast);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.modal-body {
  padding: 24px;
}

.modal-input-group {
  margin-bottom: 20px;
}

.modal-input-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.modal-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--gray-300);
  border-radius: var(--radius-md);
  font-size: 15px;
  font-family: var(--font-sans);
  transition: all var(--transition-fast);
  background: var(--light);
  color: var(--dark);
}

.modal-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(100, 45, 144, 0.1);
}

.modal-input::placeholder {
  color: var(--gray-400);
}

.modal-footer {
  padding: 20px 24px;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-200);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.modal-btn {
  padding: 10px 24px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  min-width: 100px;
}

.modal-btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--light);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.modal-btn-secondary {
  background: var(--gray-200);
  color: var(--dark);
}

.modal-btn-secondary:hover {
  background: var(--gray-300);
}

.analysis-modal-content {
  max-width: 800px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.analysis-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.analysis-header-info {
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 0.5%, var(--light) 5%);
  border-bottom: 1px solid var(--gray-200);
}

.analysis-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 8px;
}

.analysis-subtitle {
  font-size: 14px;
  color: var(--gray-600);
  display: flex;
  align-items: center;
  gap: 12px;
}

.analysis-batches {
  padding: 20px;
}

.batches-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--gray-200);
}

.batch-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.batch-item {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
}

.batch-item.expanded {
  box-shadow: var(--shadow-md);
}

.batch-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  background: var(--light);
}

.batch-header:hover {
  background: var(--gray-50);
}

.batch-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.batch-number {
  background: var(--primary);
  color: var(--light);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
}

.batch-details {
  font-size: 14px;
  color: var(--gray-700);
}

.batch-stats {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: var(--gray-600);
}

.batch-arrow {
  transition: transform var(--transition-base);
  color: var(--gray-500);
}

.batch-item.expanded .batch-arrow {
  transform: rotate(180deg);
}

.batch-content {
  padding: 0;
  max-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  transition: max-height var(--transition-base);
  border-top: 1px solid transparent;
  box-sizing: border-box;
}

.batch-item.expanded .batch-content {
  max-height: 500px;
  padding: 20px;
  border-top-color: var(--gray-200);
  overflow-y: auto;
}

.batch-analysis {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 16px;
}

.batch-analysis h4 {
  font-size: 15px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.batch-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.batch-stat {
  text-align: center;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
}

.batch-stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
}

.batch-stat-label {
  font-size: 12px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.batch-justification {
  font-size: 14px;
  color: var(--gray-700);
  line-height: 1.6;
  padding: 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--accent);
  max-height: 300px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.batch-justification strong {
  font-weight: 700;
  color: var(--primary);
}

.batch-justification u {
  text-decoration: underline;
  font-weight: 600;
  color: var(--dark);
  display: inline-block;
  min-width: 140px;
}

.batch-justification br {
  margin-bottom: 4px;
  display: block;
  content: "";
}

/* Стиль для заголовков диалогов */
.batch-justification > div > strong {
  display: block;
  font-size: 15px;
  margin: 12px 0 8px 0;
  padding-bottom: 4px;
  border-bottom: 2px solid var(--primary-light);
}
.behavior-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin: 16px 0;
}

.behavior-stat {
  text-align: center;
  padding: 16px;
  border-radius: var(--radius-md);
  transition: all var(--transition-base);
}

.behavior-stat:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.behavior-stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}

.behavior-stat-label {
  font-size: 12px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.problem-phrases h5, .behavior-history h5 {
  font-size: 14px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

@media (max-width: 768px) {
  .behavior-stats-grid {
    grid-template-columns: 1fr;
  }
  
  .employee-stats {
    grid-template-columns: 1fr;
  }
}

.loader-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1999;
  backdrop-filter: blur(4px);
}

.loader {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--light);
  padding: 40px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  z-index: 2000;
  text-align: center;
  min-width: 300px;
  max-width: 400px;
  animation: pulse 2s infinite;
}

.spinner {
  border: 4px solid var(--gray-200);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

.loader-text {
  font-size: 16px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.loader-subtext {
  font-size: 14px;
  color: var(--gray-600);
  line-height: 1.5;
}

.loader-progress {
  width: 100%;
  height: 4px;
  background: var(--gray-200);
  border-radius: 2px;
  margin-top: 20px;
  overflow: hidden;
}

.loader-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
  width: 0%;
  transition: width var(--transition-base);
  border-radius: 2px;
}

.icon {
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
  
  .header {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .logo-section {
    flex-direction: column;
    gap: 12px;
  }
  
  .stats-section {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .employee-header {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .upload-section {
    align-items: stretch;
  }
  
  .modal-content {
    width: 95%;
    margin: 20px auto;
  }
  
  .employee-stats {
    grid-template-columns: 1fr;
  }
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}

.complexity-distribution {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  gap: 8px;
}

.complexity-level {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 8px;
  border-radius: var(--radius-sm);
  min-width: 40px;
  transition: all var(--transition-fast);
}

.complexity-level:hover {
  transform: translateY(-2px);
}

.level-1 {
  background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
  color: white;
}

.level-2 {
  background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
  color: white;
}

.level-3 {
  background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
  color: white;
}

.level-4 {
  background: linear-gradient(135deg, #F44336 0%, #E57373 100%);
  color: white;
}

.complexity-label {
  font-size: 12px;
  font-weight: 700;
  margin-bottom: 2px;
  opacity: 0.9;
}

.complexity-count {
  font-size: 14px;
  font-weight: 700;
}
`;

// ============================================================================
// СОСТОЯНИЕ ПРИЛОЖЕНИЯ
// ============================================================================
class AppState {
  constructor() {
    this.employees = [];
    this.analysisData = {};
    this.aggregatedAnalysisData = {};
    this.nextEmployeeId = 106;
  }

  getEmployee(id) {
    return this.employees.find(e => e.id === id);
  }

  getAnalyses(employeeId) {
    return this.analysisData[employeeId] || [];
  }

  getAggregatedAnalyses(employeeId) {
    return this.aggregatedAnalysisData[employeeId] || [];
  }

  setEmployees(employees) {
    this.employees = employees;
    if (employees.length > 0) {
      this.nextEmployeeId = Math.max(...employees.map(e => e.id)) + 1;
    }
  }

  setAnalysisData(data) {
    this.analysisData = data;
  }

  setAggregatedAnalysisData(data) {
    this.aggregatedAnalysisData = data;
  }

  updateEmployee(id, updates) {
    const index = this.employees.findIndex(e => e.id === id);
    if (index !== -1) {
      this.employees[index] = { ...this.employees[index], ...updates };
    }
  }

  addEmployee(employee) {
    employee.id = this.nextEmployeeId++;
    employee.expanded = false;
    this.employees.push(employee);
  }
}

// ============================================================================
// API СЛОЙ
// ============================================================================
class ApiService {
  static async loadEmployees() {
    try {
      const response = await fetch(CONFIG.GET_EMPLOYEES_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки сотрудников:', error);
      return [];
    }
  }

  static async loadAnalysisData() {
    try {
      const response = await fetch(CONFIG.GET_ANALYSIS_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки анализов:', error);
      return [];
    }
  }

  static async syncEmployees(employeesData) {
    try {
      const response = await fetch(CONFIG.SYNC_EMPLOYEES_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employees: employeesData })
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return true;
    } catch (error) {
      console.error('Ошибка синхронизации:', error);
      return false;
    }
  }

  static async uploadFile(formData) {
    try {
      const response = await fetch(CONFIG.UPLOAD_DIALOGS_URL, {
        method: 'POST',
        body: formData
      });
      if (!response.ok) throw new Error(`Ошибка сервера: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки файла:', error);
      throw error;
    }
  }
}

// ============================================================================
// УТИЛИТЫ
// ============================================================================
class Utils {
  static formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  static formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  }

static markdownToHtml(text) {
  if (!text) return '';
  
  let html = text;
  
  // Преобразуем **жирный текст** в <strong>жирный текст</strong>
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // Преобразуем __подчеркнутый текст__ в <u>подчеркнутый текст</u>
  html = html.replace(/__(.*?)__/g, '<u>$1</u>');
  
  // Преобразуем переводы строк в <br>
  html = html.replace(/\n/g, '<br>');
  
  // Преобразуем "**Диалог_X**" в отдельный блок с особым стилем
  html = html.replace(/(<strong>Диалог_\d+<\/strong>):/g, '<div style="margin-top: 16px; margin-bottom: 8px;"><strong>$1</strong>:</div>');
  
  return html;
}

  static formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  static groupAnalysesByTimeWindow(analyses, timeWindow = CONFIG.AGGREGATION_TIME_WINDOW) {
    if (!analyses || analyses.length === 0) return [];
    
    const sortedAnalyses = [...analyses].sort((a, b) => 
      new Date(a.analyzed_at) - new Date(b.analyzed_at)
    );
    
    const groups = [];
    let currentGroup = [];
    let groupStartTime = null;
    
    for (const analysis of sortedAnalyses) {
      const analysisTime = new Date(analysis.analyzed_at).getTime();
      
      if (!groupStartTime) {
        groupStartTime = analysisTime;
        currentGroup = [analysis];
      } else {
        const timeDiff = analysisTime - groupStartTime;
        
        if (timeDiff <= timeWindow) {
          currentGroup.push(analysis);
        } else {
          groups.push([...currentGroup]);
          groupStartTime = analysisTime;
          currentGroup = [analysis];
        }
      }
    }
    
    if (currentGroup.length > 0) {
      groups.push(currentGroup);
    }
    
    return groups;
  }

  static createAggregatedAnalyses(analysisData) {
    const aggregated = {};
    
    for (const [employeeId, analyses] of Object.entries(analysisData)) {
      if (!analyses || analyses.length === 0) continue;
      
      const groups = Utils.groupAnalysesByTimeWindow(analyses);
      
      aggregated[employeeId] = groups.map((group, index) => {
        let totalWeightedComplexity = 0;
        let totalWeightedIER = 0;
        let totalDialogs = 0;
        
        let totalLevel1 = 0;
        let totalLevel2 = 0;
        let totalLevel3 = 0;
        let totalLevel4 = 0;
        let totalIncorrectBehavior = 0;
        let totalSwearing = 0;
        let problemPhrases = [];
        let toneDistribution = {
          professional: 0,
          neutral: 0,
          negative: 0,
          aggressive: 0
        };
        let overallTone = 'нейтральный';
        let toneRecommendations = '';
        let allToneSuggestions = [];
        
        group.forEach(batch => {
          const dialogsCount = parseInt(batch.dialogs_count) || 0;
          const complexity = parseFloat(batch.complexity_level) || 0;
          const ier = parseFloat(batch.ier_coefficient) || 0;
          
          totalWeightedComplexity += complexity * dialogsCount;
          totalWeightedIER += ier * dialogsCount;
          totalDialogs += dialogsCount;
          
          totalLevel1 += parseInt(batch.level1_count) || 0;
          totalLevel2 += parseInt(batch.level2_count) || 0;
          totalLevel3 += parseInt(batch.level3_count) || 0;
          totalLevel4 += parseInt(batch.level4_count) || 0;
          totalIncorrectBehavior += parseInt(batch.incorrect_behavior_count) || parseInt(batch.parsed_incorrect_behavior) || 0;
totalSwearing += parseInt(batch.swearing_count) || parseInt(batch.parsed_swearing) || 0;
          
          if (batch.problem_phrases) {
            try {
              const phrases = JSON.parse(batch.problem_phrases);
              if (Array.isArray(phrases)) {
                problemPhrases.push(...phrases);
              }
            } catch (e) {
              if (batch.problem_phrases.trim() !== '') {
                problemPhrases.push(batch.problem_phrases);
              }
            }
          }
          
          // ИЗВЛЕЧЕНИЕ РАСПРЕДЕЛЕНИЯ ТОНАЛЬНОСТИ
          let batchHasDistribution = false;
          
          // 1. Пробуем получить распределение из behavior_analysis_json (приоритетный источник)
          if (batch.behavior_analysis_json && batch.behavior_analysis_json !== '{}') {
            try {
              const behaviorAnalysis = JSON.parse(batch.behavior_analysis_json);
              if (behaviorAnalysis.summary && behaviorAnalysis.summary.tone_distribution) {
                const dist = behaviorAnalysis.summary.tone_distribution;
                toneDistribution.professional += dist.professional || 0;
                toneDistribution.neutral += dist.neutral || 0;
                toneDistribution.negative += dist.negative || 0;
                toneDistribution.aggressive += dist.aggressive || 0;
                batchHasDistribution = true;
              }
              
              if (behaviorAnalysis.summary && behaviorAnalysis.summary.tone_recommendations) {
                toneRecommendations = behaviorAnalysis.summary.tone_recommendations;
              }
              
              if (behaviorAnalysis.dialogs && Array.isArray(behaviorAnalysis.dialogs)) {
                behaviorAnalysis.dialogs.forEach(dialog => {
                  if (dialog.tone_improvement_suggestions && dialog.tone_improvement_suggestions.trim()) {
                    allToneSuggestions.push(`Диалог ${dialog.dialog_id}: ${dialog.tone_improvement_suggestions}`);
                  }
                });
              }
            } catch (e) {
              console.error('Ошибка парсинга behavior_analysis_json:', e.message);
              batchHasDistribution = false;
            }
          }
          
          // 2. Если нет распределения из JSON, используем overall_tone
          if (!batchHasDistribution && batch.overall_tone) {
            const tone = batch.overall_tone.toLowerCase().trim();
            const dialogsInBatch = dialogsCount > 0 ? dialogsCount : 1;
            
            if (tone.includes('профессиональный') || tone.includes('professional')) {
              toneDistribution.professional += dialogsInBatch;
            } else if (tone.includes('нейтральный') || tone.includes('neutral')) {
              toneDistribution.neutral += dialogsInBatch;
            } else if (tone.includes('негативный') || tone.includes('negative')) {
              toneDistribution.negative += dialogsInBatch;
            } else if (tone.includes('агрессивный') || tone.includes('aggressive')) {
              toneDistribution.aggressive += dialogsInBatch;
            }
          }
          
          // 3. Рекомендации из корневого поля (если еще нет)
          if (batch.tone_recommendations && batch.tone_recommendations.trim() && !toneRecommendations) {
            toneRecommendations = batch.tone_recommendations;
          }
          
          // 4. Конкретные рекомендации по диалогам из tone_distribution_json
          if (batch.tone_distribution_json && batch.tone_distribution_json.trim()) {
            // Проверяем, нет ли уже таких рекомендаций
            const suggestionExists = allToneSuggestions.some(s => s.includes(batch.tone_distribution_json));
            if (!suggestionExists) {
              allToneSuggestions.push(batch.tone_distribution_json);
            }
          }
        });
        
        // Определяем преобладающий тон на основе распределения
        const tones = Object.entries(toneDistribution);
        let maxCount = 0;
        tones.forEach(([tone, count]) => {
          if (count > maxCount) {
            maxCount = count;
            overallTone = tone;
          }
        });
        
        // Если все тона равны 0, устанавливаем нейтральный
        if (maxCount === 0) {
          overallTone = 'нейтральный';
        }
        
        const avgComplexity = totalDialogs > 0 ? 
          (totalWeightedComplexity / totalDialogs).toFixed(2) : '0';
        const avgIER = totalDialogs > 0 ? 
          (totalWeightedIER / totalDialogs).toFixed(2) : '0';
        
        const startTime = new Date(group[0].analyzed_at);
        const endTime = new Date(group[group.length - 1].analyzed_at);
        
        const dialogIds = group
          .map(a => a.dialog_ids || '')
          .filter(id => id)
          .join(', ');
        
        return {
          id: `agg_${employeeId}_${index}_${Date.now()}`,
          employee_id: parseInt(employeeId),
          start_time: startTime,
          end_time: endTime,
          total_dialogs: totalDialogs,
          batch_count: group.length,
          avg_complexity: avgComplexity,
          avg_ier: avgIER,
          total_ier: group.reduce((sum, a) => sum + (parseFloat(a.ier_coefficient) || 0), 0),
          dialog_ids: dialogIds,
          
          level_counts: {
            1: totalLevel1,
            2: totalLevel2,
            3: totalLevel3,
            4: totalLevel4
          },
          total_level1: totalLevel1,
          total_level2: totalLevel2,
          total_level3: totalLevel3,
          total_level4: totalLevel4,
          incorrect_behavior_count: totalIncorrectBehavior,
          swearing_count: totalSwearing,
          has_incorrect_behavior: totalIncorrectBehavior > 0,
          has_swearing: totalSwearing > 0,
          problem_phrases: problemPhrases,
          overall_tone: overallTone,
          tone_distribution: toneDistribution,
          tone_recommendations: toneRecommendations,
          all_tone_suggestions: allToneSuggestions,
          behavior_summary_str: group[0]?.behavior_summary_str || '',
          
          batches: group.map(batch => ({
            ...batch,
            parsed_ier: parseFloat(batch.ier_coefficient) || 0,
            parsed_complexity: parseFloat(batch.complexity_level) || 0,
            parsed_dialogs: parseInt(batch.dialogs_count) || 0,
            parsed_level1: parseInt(batch.level1_count) || 0,
            parsed_level2: parseInt(batch.level2_count) || 0,
            parsed_level3: parseInt(batch.level3_count) || 0,
            parsed_level4: parseInt(batch.level4_count) || 0,
            parsed_incorrect_behavior: parseInt(batch.incorrect_behavior_count) || 0,
            parsed_swearing: parseInt(batch.swearing_count) || 0,
            parsed_has_incorrect_behavior: batch.has_incorrect_behavior === true,
            parsed_has_swearing: batch.has_swearing === true,
            parsed_problem_phrases: batch.problem_phrases || '',
            parsed_overall_tone: batch.overall_tone || 'нейтральный',
            parsed_tone_recommendations: batch.tone_recommendations || '',
            parsed_tone_suggestions: batch.tone_distribution_json || ''
          })),
          formatted_date: Utils.formatDate(group[0].analyzed_at),
          formatted_time: `${Utils.formatTime(group[0].analyzed_at)} - ${Utils.formatTime(group[group.length - 1].analyzed_at)}`
        };
      });
    }
    
    return aggregated;
  }

  static calculateAverageIER(aggregatedAnalyses) {
    if (!aggregatedAnalyses || aggregatedAnalyses.length === 0) return 0;
    
    const validIERs = aggregatedAnalyses
      .map(a => parseFloat(a.avg_ier))
      .filter(ier => !isNaN(ier) && ier > 0);
      
    if (validIERs.length === 0) return 0;
    
    const sum = validIERs.reduce((acc, ier) => acc + ier, 0);
    return (sum / validIERs.length).toFixed(2);
  }

  static calculateComplexityDistribution(analyses) {
    const distribution = { 1: 0, 2: 0, 3: 0, 4: 0 };
    
    if (!analyses || analyses.length === 0) return distribution;
    
    analyses.forEach(analysis => {
      if (analysis.complexity_level) {
        const complexity = parseFloat(analysis.complexity_level);
        if (complexity >= 1 && complexity <= 4) {
          const dialogsCount = parseInt(analysis.dialogs_count) || 0;
          if (Number.isInteger(complexity)) {
            distribution[complexity] += dialogsCount;
          } else {
            const floor = Math.floor(complexity);
            const ceil = Math.ceil(complexity);
            const ratio = complexity - floor;
            
            distribution[floor] += Math.round(dialogsCount * (1 - ratio));
            if (ceil <= 4) {
              distribution[ceil] += Math.round(dialogsCount * ratio);
            }
          }
        }
      }
    });
    
    return distribution;
  }

  static getToneLabel(tone) {
    const toneMap = {
      professional: 'Профессиональный',
      neutral: 'Нейтральный',
      negative: 'Негативный',
      aggressive: 'Агрессивный',
      'профессиональный': 'Профессиональный',
      'нейтральный': 'Нейтральный',
      'негативный': 'Негативный',
      'агрессивный': 'Агрессивный'
    };
    return toneMap[tone] || tone || 'Не определено';
  }

  static getToneColor(tone) {
    const colorMap = {
      professional: '#1976D2',
      neutral: '#616161',
      negative: '#F57C00',
      aggressive: '#D32F2F',
      'профессиональный': '#1976D2',
      'нейтральный': '#616161',
      'негативный': '#F57C00',
      'агрессивный': '#D32F2F'
    };
    return colorMap[tone] || '#616161';
  }
}

// ============================================================================
// КОМПОНЕНТЫ UI
// ============================================================================
class UILoader {
  static show(text = 'Загрузка...', subtext = '') {
    const loader = document.getElementById('loader');
    const backdrop = document.getElementById('loaderBackdrop');
    const loaderText = document.getElementById('loaderText');
    const loaderSubtext = document.getElementById('loaderSubtext');
    
    if (loaderText) loaderText.textContent = text;
    if (loaderSubtext) loaderSubtext.textContent = subtext;
    if (loader) loader.style.display = 'block';
    if (backdrop) backdrop.style.display = 'block';
  }

  static hide() {
    const loader = document.getElementById('loader');
    const backdrop = document.getElementById('loaderBackdrop');
    const progress = document.getElementById('loaderProgress');
    
    if (loader) loader.style.display = 'none';
    if (backdrop) backdrop.style.display = 'none';
    if (progress) progress.style.width = '0%';
  }

  static updateProgress(percent) {
    const progress = document.getElementById('loaderProgress');
    if (progress) progress.style.width = `${percent}%`;
  }
}

class UIModal {
  static open(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'block';
  }

  static close(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
  }

  static setupOutsideClick() {
    window.addEventListener('click', (event) => {
      const modals = ['addEmployeeModal', 'analysisModal', 'behaviorModal', 'toneModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal && event.target === modal) {
          UIModal.close(modalId);
        }
      });
    });
  }
}

// ============================================================================
// КОМПОНЕНТЫ ПРИЛОЖЕНИЯ
// ============================================================================
class HeaderComponent {
  static render(totalEmployees, totalAnalyses, totalDialogs) {
    return `
      <header class="header">
        <div class="logo-section">
          <img src="logo.png" alt="СЕВСТАР" class="logo">
          <div class="title-section">
            <h1>Сервис ИИ-аналитики колл-центра</h1>
            <p>Интеллектуальная аналитика и оценка качества обслуживания</p>
          </div>
        </div>
        <div class="stats-section">
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-users"></i> <span>${totalEmployees}</span></div>
            <div class="stat-label">Сотрудников</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-chart-line"></i> <span>${totalAnalyses}</span></div>
            <div class="stat-label">Анализов</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-microphone"></i> <span>${totalDialogs}</span></div>
            <div class="stat-label">Диалогов</div>
          </div>
        </div>
      </header>
    `;
  }
}

class EmployeeCardComponent {
  static render(employee, aggregatedAnalyses, app) {
    let overallTone = 'нейтральный';
    const toneCounts = {
      professional: 0,
      neutral: 0,
      negative: 0,
      aggressive: 0
    };
    
    let allToneRecommendations = [];
    
    aggregatedAnalyses.forEach(agg => {
      if (agg.tone_distribution) {
        toneCounts.professional += agg.tone_distribution.professional || 0;
        toneCounts.neutral += agg.tone_distribution.neutral || 0;
        toneCounts.negative += agg.tone_distribution.negative || 0;
        toneCounts.aggressive += agg.tone_distribution.aggressive || 0;
      }
      
      if (agg.tone_recommendations) {
        allToneRecommendations.push({
          date: agg.formatted_date,
          recommendation: agg.tone_recommendations
        });
      }
    });
    
    let maxCount = 0;
    Object.entries(toneCounts).forEach(([tone, count]) => {
      if (count > maxCount) {
        maxCount = count;
        overallTone = tone;
      }
    });
    
    const avgIER = Utils.calculateAverageIER(aggregatedAnalyses);
    const lastIER = aggregatedAnalyses.length > 0 ? aggregatedAnalyses[aggregatedAnalyses.length - 1].avg_ier : '—';
    const lastDate = aggregatedAnalyses.length > 0 ? aggregatedAnalyses[aggregatedAnalyses.length - 1].formatted_date : '—';
    const totalDialogs = aggregatedAnalyses.reduce((sum, a) => sum + a.total_dialogs, 0);
    
    const totalLevel1 = aggregatedAnalyses.reduce((sum, a) => sum + (a.total_level1 || 0), 0);
    const totalLevel2 = aggregatedAnalyses.reduce((sum, a) => sum + (a.total_level2 || 0), 0);
    const totalLevel3 = aggregatedAnalyses.reduce((sum, a) => sum + (a.total_level3 || 0), 0);
    const totalLevel4 = aggregatedAnalyses.reduce((sum, a) => sum + (a.total_level4 || 0), 0);
    const totalIncorrectBehavior = aggregatedAnalyses.reduce((sum, a) => sum + (a.incorrect_behavior_count || 0), 0);
    const totalSwearing = aggregatedAnalyses.reduce((sum, a) => sum + (a.swearing_count || 0), 0);
    
    return `
      <div class="employee-card" data-employee-id="${employee.id}">
        <div class="employee-header">
          <div class="employee-info">
            <h3 onclick="app.handlers.editEmployeeName(${employee.id}, '${employee.name.replace(/'/g, "\\'")}')">
              ${employee.name}
            </h3>
            <div class="employee-position">
              <i class="fas fa-briefcase"></i>
              ${employee.position}
            </div>
          </div>
          
          <div class="upload-section">
            <label class="upload-button">
              <i class="fas fa-upload"></i>
              Загрузить диалоги
              <input type="file" class="file-input" 
                     accept="${CONFIG.SUPPORTED_FORMATS}" 
                     onchange="app.handlers.handleUpload(event, ${employee.id})">
            </label>
            <div class="file-types">TXT, JSON, CSV, Excel, Word, PDF</div>
          </div>
        </div>
        
        <div class="employee-stats">
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-chart-line"></i>
              Итоговый ИЭР
            </div>
            <div class="stat-card-value">${avgIER || '—'}</div>
            <div class="stat-card-subtitle">Средний коэффициент</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-clock"></i>
              Последний ИЭР
            </div>
            <div class="stat-card-value">${lastIER}</div>
            <div class="stat-card-subtitle">${lastDate}</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-layer-group"></i>
              Анализов
            </div>
            <div class="stat-card-value">${aggregatedAnalyses.length}</div>
            <div class="stat-card-subtitle">Агрегированных</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-comments"></i>
              Диалогов
            </div>
            <div class="stat-card-value">${totalDialogs}</div>
            <div class="stat-card-subtitle">Всего обработано</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-signal"></i>
              Распределение по сложности
            </div>
            <div class="complexity-distribution">
              <div class="complexity-level level-1" title="Уровень 1 (Простые)">
                <span class="complexity-label">1</span>
                <span class="complexity-count">${totalLevel1}</span>
              </div>
              <div class="complexity-level level-2" title="Уровень 2 (Средние)">
                <span class="complexity-label">2</span>
                <span class="complexity-count">${totalLevel2}</span>
              </div>
              <div class="complexity-level level-3" title="Уровень 3 (Сложные)">
                <span class="complexity-label">3</span>
                <span class="complexity-count">${totalLevel3}</span>
              </div>
              <div class="complexity-level level-4" title="Уровень 4 (Очень сложные)">
                <span class="complexity-label">4</span>
                <span class="complexity-count">${totalLevel4}</span>
              </div>
            </div>
            <div class="stat-card-subtitle">Уровни сложности диалогов</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-exclamation-triangle"></i>
              Анализ поведения
            </div>
            <div class="complexity-distribution">
              <div class="complexity-level" style="background: linear-gradient(135deg, #FF4757 0%, #FF6B81 100%); color: white;">
                <span class="complexity-label">⚠️</span>
                <span class="complexity-count">${totalIncorrectBehavior}</span>
              </div>
              <div class="complexity-level" style="background: linear-gradient(135deg, #FF9F43 0%, #FFC061 100%); color: white;">
                <span class="complexity-label">🔞</span>
                <span class="complexity-count">${totalSwearing}</span>
              </div>
            </div>
            <div class="stat-card-subtitle">Некорректное поведение / Ругательства</div>
            ${totalIncorrectBehavior > 0 || totalSwearing > 0 ? 
              `<button class="details-toggle" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;" onclick="app.handlers.openBehaviorModal(${employee.id})">
                <i class="fas fa-info-circle"></i> Детали поведения
              </button>` : ''
            }
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-comments"></i>
              Тональность общения
            </div>
            <div class="stat-card-value" style="font-size: 20px; color: ${Utils.getToneColor(overallTone)}">
              ${Utils.getToneLabel(overallTone)}
            </div>
            <div class="stat-card-subtitle">
              Проф: ${toneCounts.professional}, Нейтр: ${toneCounts.neutral}<br>
              Негат: ${toneCounts.negative}, Агресс: ${toneCounts.aggressive}
            </div>
            ${allToneRecommendations.length > 0 ? `
              <div style="font-size: 11px; color: var(--primary); margin-top: 4px;">
                <i class="fas fa-lightbulb"></i> Есть рекомендации
              </div>
            ` : ''}
            <button class="details-toggle" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;" onclick="app.handlers.openToneModal(${employee.id})">
              <i class="fas fa-chart-bar"></i> Подробный анализ
            </button>
          </div>
        </div>
        
        <button class="details-toggle" onclick="app.handlers.toggleEmployeeDetails(${employee.id})">
          <i class="fas fa-${employee.expanded ? 'chevron-up' : 'chevron-down'}"></i>
          ${employee.expanded ? 'Скрыть детали' : 'Показать историю анализов'}
        </button>
        
        ${employee.expanded ? this.renderDetails(employee, aggregatedAnalyses) : ''}
      </div>
    `;
  }

  static renderDetails(employee, aggregatedAnalyses) {
    return `
      <div class="employee-details">
        <div class="details-title">
          <i class="fas fa-history"></i>
          История агрегированных анализов
        </div>
        
        ${aggregatedAnalyses.length > 0 ? this.renderAnalysisHistory(employee, aggregatedAnalyses) : this.renderNoData()}
      </div>
    `;
  }

  static renderAnalysisHistory(employee, aggregatedAnalyses) {
    const items = aggregatedAnalyses.map((agg, index) => `
      <div class="analysis-item" onclick="app.handlers.openAnalysisModal(${employee.id}, ${index})">
        <div class="analysis-header">
          <div class="analysis-date">
            <i class="fas fa-calendar"></i>
            ${agg.formatted_date}
            ${agg.has_incorrect_behavior ? ' <span style="color: #FF4757; margin-left: 8px;">⚠️</span>' : ''}
            ${agg.has_swearing ? ' <span style="color: #FF9F43;">🔞</span>' : ''}
          </div>
          <div class="analysis-stats">
            <div class="analysis-stat">
              <i class="fas fa-clock"></i>
              ${agg.formatted_time}
            </div>
            <div class="analysis-stat">
              <i class="fas fa-layer-group"></i>
              ${agg.batch_count} батчей
            </div>
          </div>
        </div>
        <div class="analysis-summary">
          <strong>Диалогов:</strong> ${agg.total_dialogs} • 
          <strong>Средний ИЭР:</strong> ${agg.avg_ier} • 
          <strong>Средняя сложность:</strong> ${agg.avg_complexity}
          ${agg.incorrect_behavior_count > 0 ? ` • <strong style="color: #FF4757;">Некорр.поведение:</strong> ${agg.incorrect_behavior_count}` : ''}
          ${agg.swearing_count > 0 ? ` • <strong style="color: #FF9F43;">Ругательства:</strong> ${agg.swearing_count}` : ''}
        </div>
      </div>
    `).join('');
    
    return `<div class="analysis-history">${items}</div>`;
  }

  static renderNoData() {
    return `
      <div class="no-data">
        <i class="fas fa-chart-line"></i>
        <p>Анализы отсутствуют. Загрузите диалоги для начала анализа.</p>
      </div>
    `;
  }
}

class AnalysisModalComponent {
  static render(employee, aggregatedAnalysis) {
    return `
      <div class="modal-content analysis-modal-content">
        <div class="modal-header">
          <h3>Анализ диалогов: ${employee.name}</h3>
          <button class="close-btn" onclick="UIModal.close('analysisModal')">&times;</button>
        </div>
        <div class="analysis-modal-body">
          <div class="analysis-header-info">
            <div class="analysis-title">Агрегированный анализ</div>
            <div class="analysis-subtitle">
              <i class="fas fa-calendar-alt"></i>
              <span>${aggregatedAnalysis.formatted_date}</span>
              <i class="fas fa-clock"></i>
              <span>${aggregatedAnalysis.formatted_time}</span>
            </div>
          </div>
          
          <div class="analysis-batches">
            <div class="batches-title">
              <i class="fas fa-layer-group"></i>
              Батчи анализа (${aggregatedAnalysis.batch_count})
            </div>
            <div class="batch-list">
              ${aggregatedAnalysis.batches.map((batch, index) => this.renderBatch(batch, index, aggregatedAnalysis.employee_id)).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  static renderBatch(batch, index, employeeId) {
    const batchTime = Utils.formatTime(batch.analyzed_at);
    
    return `
      <div class="batch-item" id="batch-${employeeId}-${index}">
        <div class="batch-header" onclick="app.handlers.toggleBatchDetails(${employeeId}, ${index})">
          <div class="batch-info">
            <div class="batch-number">${index + 1}</div>
            <div class="batch-details">
              Батч от ${batchTime} • ${batch.dialogs_count} диалогов
              ${batch.parsed_has_incorrect_behavior ? ' <span style="color: #FF4757;">⚠️</span>' : ''}
              ${batch.parsed_has_swearing ? ' <span style="color: #FF9F43;">🔞</span>' : ''}
            </div>
          </div>
          <div class="batch-stats">
            <div class="batch-stat">
              <i class="fas fa-chart-line"></i>
              <span>ИЭР: ${batch.ier_coefficient}</span>
            </div>
            <div class="batch-stat">
              <i class="fas fa-layer-group"></i>
              <span>Сложность: ${batch.complexity_level}</span>
            </div>
            ${batch.parsed_has_incorrect_behavior || batch.parsed_has_swearing ? `
              <div class="batch-stat">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Поведение</span>
              </div>
            ` : ''}
            ${batch.parsed_tone_recommendations ? `
              <div class="batch-stat">
                <i class="fas fa-comments"></i>
                <span>Тон</span>
              </div>
            ` : ''}
          </div>
          <div class="batch-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="batch-content">
          <div class="batch-analysis">
            <h4><i class="fas fa-chart-bar"></i> Статистика батча</h4>
            <div class="batch-stats-grid">
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.dialogs_count}</div>
                <div class="batch-stat-label">Диалогов</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.ier_coefficient}</div>
                <div class="batch-stat-label">ИЭР</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.complexity_level}</div>
                <div class="batch-stat-label">Сложность</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_count || 0}</div>
                <div class="batch-stat-label">Обработано</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_level1 || 0}</div>
                <div class="batch-stat-label">Ур.1</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_level2 || 0}</div>
                <div class="batch-stat-label">Ур.2</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_level3 || 0}</div>
                <div class="batch-stat-label">Ур.3</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_level4 || 0}</div>
                <div class="batch-stat-label">Ур.4</div>
              </div>
            </div>
            
            ${batch.parsed_tone_recommendations ? `
              <h4><i class="fas fa-comments"></i> Анализ тональности</h4>
              <div class="batch-stats-grid">
                <div class="batch-stat">
                  <div class="batch-stat-value" style="font-size: 16px;">${batch.parsed_overall_tone || 'нейтральный'}</div>
                  <div class="batch-stat-label">Общий тон</div>
                </div>
              </div>
              ${batch.parsed_tone_recommendations ? `
                <div style="margin-top: 12px; padding: 12px; background: #E8F5E9; border-radius: var(--radius-md);">
                  <strong>Рекомендации по тону:</strong>
                  <div style="margin-top: 8px; font-size: 13px;">${batch.parsed_tone_recommendations}</div>
                </div>
              ` : ''}
              ${batch.parsed_tone_suggestions ? `
                <div style="margin-top: 12px; padding: 12px; background: #E3F2FD; border-radius: var(--radius-md);">
                  <strong>Конкретные рекомендации:</strong>
                  <div style="margin-top: 8px; font-size: 13px;">${batch.parsed_tone_suggestions}</div>
                </div>
              ` : ''}
            ` : ''}
            
            ${batch.parsed_has_incorrect_behavior || batch.parsed_has_swearing ? `
              <h4><i class="fas fa-user-check"></i> Анализ поведения</h4>
              <div class="batch-stats-grid">
                <div class="batch-stat" style="background: ${batch.parsed_incorrect_behavior > 0 ? '#FFE8E8' : 'var(--gray-50)'};">
                  <div class="batch-stat-value" style="color: ${batch.parsed_incorrect_behavior > 0 ? '#FF4757' : 'var(--primary)'};">${batch.parsed_incorrect_behavior || 0}</div>
                  <div class="batch-stat-label">Некорректное поведение</div>
                </div>
                <div class="batch-stat" style="background: ${batch.parsed_swearing > 0 ? '#FFF4E8' : 'var(--gray-50)'};">
                  <div class="batch-stat-value" style="color: ${batch.parsed_swearing > 0 ? '#FF9F43' : 'var(--primary)'};">${batch.parsed_swearing || 0}</div>
                  <div class="batch-stat-label">Ругательства</div>
                </div>
              </div>
              
              ${batch.parsed_problem_phrases ? `
                <h4><i class="fas fa-comment-exclamation"></i> Проблемные фразы</h4>
                <div class="batch-justification" style="max-height: 150px;">
                  ${typeof batch.parsed_problem_phrases === 'string' ? 
                    batch.parsed_problem_phrases : 
                    (Array.isArray(batch.parsed_problem_phrases) ? 
                      batch.parsed_problem_phrases.map(p => `• ${p}`).join('<br>') : 
                      'Нет данных')
                  }
                </div>
              ` : ''}
            ` : ''}
            
            <h4><i class="fas fa-comment-alt"></i> Обоснование</h4>
<div class="batch-justification">${Utils.markdownToHtml(batch.justification) || 'Обоснование отсутствует'}</div>
          </div>
        </div>
      </div>
    `;
  }
}

// ============================================================================
// ГЛАВНОЕ ПРИЛОЖЕНИЕ
// ============================================================================
class App {
  constructor() {
    this.state = new AppState();
    this.handlers = this.createHandlers();
    this.init();
  }

  async init() {
    this.addStyles();
    this.renderApp();
    await this.loadData();
    this.updateUI();
  }

  addStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = STYLES;
    document.head.appendChild(styleElement);
  }

  renderApp() {
    const appContainer = document.getElementById('app');
    appContainer.innerHTML = `
      <div class="container">
        <div id="header"></div>
        
        <main class="main-content">
          <div class="employee-cards-container">
            <div class="section-header">
              <div class="section-title">
                <i class="fas fa-users-cog"></i>
                <span>Отдел колл-центра</span>
              </div>
              <button class="add-employee-btn" onclick="app.handlers.openAddEmployeeModal()">
                <i class="fas fa-user-plus"></i>
                Добавить сотрудника
              </button>
            </div>
            
            <div class="security-note">
              * В целях сохранности данных, для удаления сотрудника обратитесь к <span>администратору</span>.
            </div>
            
            <div id="content"></div>
          </div>
        </main>
      </div>
      
      <div class="loader-backdrop" id="loaderBackdrop"></div>
      <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">Загрузка и обработка файла...</div>
        <div class="loader-subtext" id="loaderSubtext"></div>
        <div class="loader-progress">
          <div class="loader-progress-bar" id="loaderProgress"></div>
        </div>
      </div>
      
      <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Добавить сотрудника</h3>
            <button class="close-btn" onclick="UIModal.close('addEmployeeModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="modal-input-group">
              <label for="newEmpName">ФИО сотрудника</label>
              <input type="text" id="newEmpName" class="modal-input" placeholder="Иванов Иван Иванович">
            </div>
            <div class="modal-input-group">
              <label for="newEmpPosition">Должность</label>
              <input type="text" id="newEmpPosition" class="modal-input" placeholder="Оператор колл-центра">
            </div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="UIModal.close('addEmployeeModal')">Отмена</button>
            <button class="modal-btn modal-btn-primary" onclick="app.handlers.saveNewEmployee()">Сохранить</button>
          </div>
        </div>
      </div>
      <div id="analysisModal" class="modal"></div>
      <div id="behaviorModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Детальный анализ поведения</h3>
            <button class="close-btn" onclick="UIModal.close('behaviorModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div id="behaviorModalContent"></div>
          </div>
        </div>
      </div>
      <div id="toneModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Анализ тональности общения</h3>
            <button class="close-btn" onclick="UIModal.close('toneModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div id="toneModalContent"></div>
          </div>
        </div>
      </div>
    `;
    
    UIModal.setupOutsideClick();
  }

  async loadData() {
    UILoader.show('Загрузка данных...', 'Подключение к сервису AI-аналитики');
    
    try {
      const employeesData = await ApiService.loadEmployees();
      if (Array.isArray(employeesData) && employeesData.length > 0) {
        const employees = employeesData.map(row => ({
          id: parseInt(row.employee_id),
          name: row.name,
          position: row.position,
          expanded: false
        }));
        this.state.setEmployees(employees);
      }

      const analysisRows = await ApiService.loadAnalysisData();
      const analysisData = {};
      
      if (Array.isArray(analysisRows)) {
        analysisRows.forEach(row => {
          const empId = parseInt(row.employee_id);
          if (!analysisData[empId]) analysisData[empId] = [];
          
          analysisData[empId].push({
            date: row.analyzed_at,
            dialogs_count: row.dialogs_count,
            dialog_ids: row.dialog_ids || '',
            complexity_level: row.complexity_level,
            ier_coefficient: row.ier_coefficient,
            justification: row.justification,
            sum_complexity: row.sum_complexity,
            batch_summary: row.batch_summary,
            parsed_count: row.parsed_count,
            analyzed_at: row.analyzed_at,
            
            level1_count: row.level1_count || 0,
            level2_count: row.level2_count || 0,
            level3_count: row.level3_count || 0,
            level4_count: row.level4_count || 0,
            levelcounts_summary: row.levelcounts_summary || '',
            incorrect_behavior_count: row.incorrect_behavior_count || 0,
            swearing_count: row.swearing_count || 0,
            has_incorrect_behavior: row.has_incorrect_behavior || false,
            has_swearing: row.has_swearing || false,
            problem_phrases: row.problem_phrases || '',
            overall_tone: row.overall_tone || 'нейтральный',
            tone_recommendations: row.tone_recommendations || '',
            tone_distribution_json: row.tone_distribution_json || '',
            behavior_summary_str: row.behavior_summary_str || '',
            behavior_analysis_json: row.behavior_analysis_json || '{}'
          });
        });
      }
      
      this.state.setAnalysisData(analysisData);
      
      const aggregated = Utils.createAggregatedAnalyses(analysisData);
      this.state.setAggregatedAnalysisData(aggregated);
      
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
    } finally {
      UILoader.hide();
    }
  }

  updateUI() {
    this.updateStats();
    this.renderEmployees();
  }

  updateStats() {
    const totalEmployees = this.state.employees.length;
    
    let totalAnalyses = 0;
    let totalDialogs = 0;
    
    Object.values(this.state.analysisData).forEach(analyses => {
      totalAnalyses += analyses.length;
      analyses.forEach(a => {
        totalDialogs += parseInt(a.dialogs_count) || 0;
      });
    });
    
    const headerContainer = document.getElementById('header');
    if (headerContainer) {
      headerContainer.innerHTML = HeaderComponent.render(totalEmployees, totalAnalyses, totalDialogs);
    }
  }

  renderEmployees() {
    const contentContainer = document.getElementById('content');
    
    if (this.state.employees.length === 0) {
      contentContainer.innerHTML = `
        <div class="no-data">
          <i class="fas fa-users-slash"></i>
          <h3>Сотрудники не найдены</h3>
          <p>Добавьте первого сотрудника, нажав кнопку "Добавить сотрудника"</p>
        </div>
      `;
      return;
    }
    
    const cards = this.state.employees.map(employee => {
      const aggregatedAnalyses = this.state.getAggregatedAnalyses(employee.id);
      return EmployeeCardComponent.render(employee, aggregatedAnalyses, this);
    }).join('');
    
    contentContainer.innerHTML = cards;
  }

  createHandlers() {
    return {
      handleUpload: async (event, employeeId) => {
        const file = event.target.files[0];
        if (!file) return;

        const employee = this.state.getEmployee(employeeId);
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);

        if (file.size > CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024) {
          alert(`Файл слишком большой. Максимальный размер: ${CONFIG.MAX_FILE_SIZE_MB} МБ`);
          event.target.value = '';
          return;
        }

        if (file.size > CONFIG.WARN_FILE_SIZE_MB * 1024 * 1024) {
          const confirmUpload = confirm(
            `Файл довольно большой (${fileSizeMB} МБ). Обработка может занять несколько минут.\n\nПродолжить загрузку?`
          );
          
          if (!confirmUpload) {
            event.target.value = '';
            return;
          }
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('employeeId', employeeId);
        formData.append('employeeName', employee.name);

        UILoader.show('Загрузка файла...', `Файл: ${file.name}\nРазмер: ${fileSizeMB} МБ`);

        try {
          const result = await ApiService.uploadFile(formData);
          UILoader.hide();
          
          alert(`✅ Файл успешно обработан!\n\nСотрудник: ${employee.name}\nДиалогов: ${result.total || result.processed || 'N/A'}`);
          
          UILoader.show('Обновление данных...');
          await this.loadData();
          this.updateUI();
          UILoader.hide();
          
        } catch (error) {
          UILoader.hide();
          alert(`❌ Ошибка при загрузке файла:\n\n${error.message}\n\nПроверьте подключение к интернету и попробуйте снова.`);
        }

        event.target.value = '';
      },

      editEmployeeName: async (employeeId, currentName) => {
        const employee = this.state.getEmployee(employeeId);
        if (!employee) return;

        const newName = prompt('Введите новое имя сотрудника:', currentName);
        if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
          this.state.updateEmployee(employeeId, { name: newName.trim() });
          this.updateUI();
          
          const employeesData = this.state.employees.map(emp => ({
            id: emp.id,
            name: emp.name,
            position: emp.position,
            summary: {
              final_score: 0,
              final_grade: 'N/A',
              last_score: 0,
              last_grade: 'N/A',
              last_review_date: ''
            },
            details: {
              data: {
                grade_history: [],
                review_details: []
              }
            }
          }));
          
          await ApiService.syncEmployees(employeesData);
        }
      },

      toggleEmployeeDetails: (employeeId) => {
        const employee = this.state.getEmployee(employeeId);
        if (employee) {
          this.state.updateEmployee(employeeId, { expanded: !employee.expanded });
          this.renderEmployees();
        }
      },

      openAnalysisModal: (employeeId, analysisIndex) => {
        const employee = this.state.getEmployee(employeeId);
        const aggregatedAnalyses = this.state.getAggregatedAnalyses(employeeId);
        
        if (employee && aggregatedAnalyses[analysisIndex]) {
          const modalContainer = document.getElementById('analysisModal');
          modalContainer.innerHTML = AnalysisModalComponent.render(employee, aggregatedAnalyses[analysisIndex]);
          UIModal.open('analysisModal');
        }
      },

      toggleBatchDetails: (employeeId, batchIndex) => {
        const batchElement = document.getElementById(`batch-${employeeId}-${batchIndex}`);
        if (batchElement) {
          batchElement.classList.toggle('expanded');
        }
      },

      openAddEmployeeModal: () => {
        UIModal.open('addEmployeeModal');
        document.getElementById('newEmpName').value = '';
        document.getElementById('newEmpPosition').value = '';
        document.getElementById('newEmpName').focus();
      },

      saveNewEmployee: async () => {
        const name = document.getElementById('newEmpName').value.trim();
        const position = document.getElementById('newEmpPosition').value.trim();

        if (!name || !position) {
          alert('Пожалуйста, заполните все поля');
          return;
        }

        this.state.addEmployee({ name, position });
        UIModal.close('addEmployeeModal');
        this.updateUI();

        const employeesData = this.state.employees.map(emp => ({
          id: emp.id,
          name: emp.name,
          position: emp.position,
          summary: {
            final_score: 0,
            final_grade: 'N/A',
            last_score: 0,
            last_grade: 'N/A',
            last_review_date: ''
          },
          details: {
            data: {
              grade_history: [],
              review_details: []
            }
          }
        }));
        
        await ApiService.syncEmployees(employeesData);
      },

      openBehaviorModal: (employeeId) => {
        const employee = this.state.getEmployee(employeeId);
        const aggregatedAnalyses = this.state.getAggregatedAnalyses(employeeId);
        
        if (employee && aggregatedAnalyses.length > 0) {
          let behaviorData = {
            employeeName: employee.name,
            totalIncorrectBehavior: 0,
            totalSwearing: 0,
            problemPhrases: [],
            analysisHistory: []
          };
          
          aggregatedAnalyses.forEach((agg, index) => {
            behaviorData.totalIncorrectBehavior += agg.incorrect_behavior_count || 0;
            behaviorData.totalSwearing += agg.swearing_count || 0;
            
            if (agg.problem_phrases && Array.isArray(agg.problem_phrases)) {
              behaviorData.problemPhrases.push(...agg.problem_phrases);
            }
            
            behaviorData.analysisHistory.push({
              date: agg.formatted_date,
              time: agg.formatted_time,
              incorrect_behavior_count: agg.incorrect_behavior_count || 0,
              swearing_count: agg.swearing_count || 0,
              overall_tone: agg.overall_tone || 'нейтральный'
            });
          });
          
          const modalContent = document.getElementById('behaviorModalContent');
          modalContent.innerHTML = `
            <div class="behavior-analysis" style="max-height: 70vh; overflow-y: auto; padding-right: 8px;">
              <h4>Сотрудник: ${behaviorData.employeeName}</h4>
              
              <div class="behavior-summary">
                <h5><i class="fas fa-chart-pie"></i> Общая статистика</h5>
                <div class="behavior-stats-grid">
                  <div class="behavior-stat" style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-md);">
                    <div class="behavior-stat-value" style="font-size: 24px; color: #FF4757;">${behaviorData.totalIncorrectBehavior}</div>
                    <div class="behavior-stat-label">Некорректное поведение</div>
                  </div>
                  <div class="behavior-stat" style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-md);">
                    <div class="behavior-stat-value" style="font-size: 24px; color: #FF9F43;">${behaviorData.totalSwearing}</div>
                    <div class="behavior-stat-label">Ругательства</div>
                  </div>
                </div>
              </div>
              
              ${behaviorData.problemPhrases.length > 0 ? `
                <div class="problem-phrases" style="margin-top: 20px;">
                  <h5><i class="fas fa-comment-exclamation"></i> Проблемные фразы (${behaviorData.problemPhrases.length})</h5>
                  <div style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;">
                    ${behaviorData.problemPhrases.map((phrase, i) => `
                      <div style="padding: 8px; border-bottom: 1px solid var(--gray-200);">
                        ${i + 1}. "${phrase}"
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div class="behavior-history" style="margin-top: 20px;">
                <h5><i class="fas fa-history"></i> История по анализам</h5>
                <div style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-md); max-height: 300px; overflow-y: auto;">
                  ${behaviorData.analysisHistory.map((item, i) => `
                    <div style="padding: 12px; border-bottom: 1px solid var(--gray-200);">
                      <strong>${item.date} (${item.time})</strong><br>
                      Некорректное поведение: ${item.incorrect_behavior_count}<br>
                      Ругательства: ${item.swearing_count}<br>
                      Общий тон: ${item.overall_tone}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
          
          UIModal.open('behaviorModal');
        }
      },

      openToneModal: (employeeId) => {
        const employee = this.state.getEmployee(employeeId);
        const aggregatedAnalyses = this.state.getAggregatedAnalyses(employeeId);
        
        if (employee && aggregatedAnalyses.length > 0) {
          let toneData = {
            employeeName: employee.name,
            totalDialogs: 0,
            totalDialogsWithTone: 0,
            toneDistribution: {
              professional: 0,
              neutral: 0,
              negative: 0,
              aggressive: 0
            },
            allRecommendations: [],
            analysisHistory: []
          };
          
          aggregatedAnalyses.forEach((agg, index) => {
            toneData.totalDialogs += agg.total_dialogs || 0;
            
            if (agg.tone_distribution) {
              // Суммируем распределение тональности
              toneData.toneDistribution.professional += agg.tone_distribution.professional || 0;
              toneData.toneDistribution.neutral += agg.tone_distribution.neutral || 0;
              toneData.toneDistribution.negative += agg.tone_distribution.negative || 0;
              toneData.toneDistribution.aggressive += agg.tone_distribution.aggressive || 0;
              
              // Считаем общее количество диалогов с определенной тональностью
              toneData.totalDialogsWithTone += (
                (agg.tone_distribution.professional || 0) +
                (agg.tone_distribution.neutral || 0) +
                (agg.tone_distribution.negative || 0) +
                (agg.tone_distribution.aggressive || 0)
              );
            }
            
            if (agg.tone_recommendations && agg.tone_recommendations.trim()) {
              toneData.allRecommendations.push({
                date: agg.formatted_date,
                recommendation: agg.tone_recommendations
              });
            }
            
            toneData.analysisHistory.push({
              date: agg.formatted_date,
              time: agg.formatted_time,
              overall_tone: agg.overall_tone || 'нейтральный',
              tone_distribution: agg.tone_distribution || {},
              dialogs_count: agg.total_dialogs,
              tone_recommendations: agg.tone_recommendations || '',
              all_tone_suggestions: agg.all_tone_suggestions || []
            });
          });
          
          // Находим преобладающий тон
          const maxTone = Object.entries(toneData.toneDistribution)
            .reduce((max, current) => current[1] > max[1] ? current : max, ['neutral', 0]);
          
          // Используем totalDialogsWithTone для расчета процентов
          const dialogsForPercentage = toneData.totalDialogsWithTone > 0 ? 
            toneData.totalDialogsWithTone : toneData.totalDialogs;
          
          const modalContent = document.getElementById('toneModalContent');
          modalContent.innerHTML = `
            <div class="tone-analysis" style="max-height: 70vh; overflow-y: auto; padding-right: 8px;">
              <h4 style="margin-bottom: 8px;">${toneData.employeeName}</h4>
              <p style="color: var(--gray-600); margin-bottom: 20px;">
                Всего проанализировано диалогов: ${toneData.totalDialogs}
                ${toneData.totalDialogsWithTone > 0 ? `<br><small style="font-size: 12px;">С определенной тональностью: ${toneData.totalDialogsWithTone}</small>` : ''}
              </p>
              
              <div class="tone-summary">
                <h5><i class="fas fa-chart-pie"></i> Распределение тональности</h5>
                <div class="behavior-stats-grid" style="margin: 16px 0;">
                  <div class="behavior-stat" style="background: #E3F2FD; padding: 16px; border-radius: var(--radius-md); text-align: center;">
                    <div class="behavior-stat-value" style="font-size: 28px; color: #1976D2; font-weight: 700;">${toneData.toneDistribution.professional || 0}</div>
                    <div class="behavior-stat-label">Профессиональный</div>
                  </div>
                  <div class="behavior-stat" style="background: #F5F5F5; padding: 16px; border-radius: var(--radius-md); text-align: center;">
                    <div class="behavior-stat-value" style="font-size: 28px; color: #616161; font-weight: 700;">${toneData.toneDistribution.neutral || 0}</div>
                    <div class="behavior-stat-label">Нейтральный</div>
                  </div>
                  <div class="behavior-stat" style="background: #FFF3E0; padding: 16px; border-radius: var(--radius-md); text-align: center;">
                    <div class="behavior-stat-value" style="font-size: 28px; color: #F57C00; font-weight: 700;">${toneData.toneDistribution.negative || 0}</div>
                    <div class="behavior-stat-label">Негативный</div>
                  </div>
                  <div class="behavior-stat" style="background: #FFEBEE; padding: 16px; border-radius: var(--radius-md); text-align: center;">
                    <div class="behavior-stat-value" style="font-size: 28px; color: #D32F2F; font-weight: 700;">${toneData.toneDistribution.aggressive || 0}</div>
                    <div class="behavior-stat-label">Агрессивный</div>
                  </div>
                </div>
                
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: var(--radius-md); margin-top: 16px; border-left: 4px solid var(--primary);">
                  <strong>Преобладающий тон: </strong>
                  <span style="color: ${maxTone[0] === 'professional' ? '#1976D2' : 
                                   maxTone[0] === 'neutral' ? '#616161' : 
                                   maxTone[0] === 'negative' ? '#F57C00' : '#D32F2F'}; 
                                   font-weight: 700; margin-left: 8px;">
                    ${maxTone[0] === 'professional' ? 'Профессиональный' :
                      maxTone[0] === 'neutral' ? 'Нейтральный' :
                      maxTone[0] === 'negative' ? 'Негативный' : 'Агрессивный'}
                  </span>
                  <div style="font-size: 14px; color: var(--gray-600); margin-top: 4px;">
                    Встречается в ${maxTone[1]} из ${dialogsForPercentage} диалогов 
                    (${dialogsForPercentage > 0 ? Math.round((maxTone[1] / dialogsForPercentage) * 100) : 0}%)
                  </div>
                </div>
              </div>
              
              <div class="tone-history" style="margin-top: 24px;">
                <h5><i class="fas fa-history"></i> История по анализам</h5>
                <div style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-md); max-height: 300px; overflow-y: auto; margin-top: 12px;">
                  ${toneData.analysisHistory.map((item, i) => {
                    const itemTones = item.tone_distribution;
                    
                    // Вычисляем общее количество диалогов с тональностью в этом анализе
                    const itemTotalDialogsWithTone = (
                      (itemTones.professional || 0) +
                      (itemTones.neutral || 0) +
                      (itemTones.negative || 0) +
                      (itemTones.aggressive || 0)
                    );
                    
                    // Находим преобладающий тон для этого анализа
                    const itemMaxTone = Object.entries(itemTones)
                      .reduce((max, current) => current[1] > max[1] ? current : max, ['neutral', 0]);
                    
                    return `
                      <div style="padding: 16px; border-bottom: 1px solid var(--gray-200); ${i === 0 ? 'border-top: none;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div style="flex: 1;">
                            <strong>${item.date}</strong>
                            <div style="font-size: 13px; color: var(--gray-600);">
                              ${item.time} • ${item.dialogs_count} диалогов
                              ${itemTotalDialogsWithTone > 0 ? 
                                `(${itemTotalDialogsWithTone} с тональностью)` : ''}
                            </div>
                            ${item.tone_recommendations ? `
                              <div style="margin-top: 8px; padding: 8px; background: #E8F5E9; border-radius: 4px; border-left: 3px solid #4CAF50;">
                                <div style="font-weight: 600; color: #2E7D32;">Рекомендация:</div>
                                <div style="font-size: 13px;">${item.tone_recommendations}</div>
                              </div>
                            ` : ''}
                          </div>
                          <div style="text-align: right; margin-left: 16px;">
                            <div style="font-weight: 600; color: ${itemMaxTone[0] === 'professional' ? '#1976D2' : 
                                                                 itemMaxTone[0] === 'neutral' ? '#616161' : 
                                                                 itemMaxTone[0] === 'negative' ? '#F57C00' : '#D32F2F'}">
                              ${item.overall_tone === 'professional' ? 'Профессиональный' :
                                item.overall_tone === 'neutral' ? 'Нейтральный' :
                                item.overall_tone === 'negative' ? 'Негативный' : 
                                item.overall_tone === 'aggressive' ? 'Агрессивный' : item.overall_tone}
                            </div>
                          </div>
                        </div>
                        
                        ${itemTotalDialogsWithTone > 0 ? `
                          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px;">
                            <div style="text-align: center; padding: 6px; background: #E3F2FD; border-radius: 4px;">
                              <div style="font-weight: 700;">${itemTones.professional || 0}</div>
                              <div style="font-size: 11px; color: #1976D2;">Проф.</div>
                            </div>
                            <div style="text-align: center; padding: 6px; background: #F5F5F5; border-radius: 4px;">
                              <div style="font-weight: 700;">${itemTones.neutral || 0}</div>
                              <div style="font-size: 11px; color: #616161;">Нейтр.</div>
                            </div>
                            <div style="text-align: center; padding: 6px; background: #FFF3E0; border-radius: 4px;">
                              <div style="font-weight: 700;">${itemTones.negative || 0}</div>
                              <div style="font-size: 11px; color: #F57C00;">Негат.</div>
                            </div>
                            <div style="text-align: center; padding: 6px; background: #FFEBEE; border-radius: 4px;">
                              <div style="font-weight: 700;">${itemTones.aggressive || 0}</div>
                              <div style="font-size: 11px; color: #D32F2F;">Агрес.</div>
                            </div>
                          </div>
                        ` : `
                          <div style="margin-top: 12px; padding: 8px; background: #FFF9E6; border-radius: 4px; text-align: center;">
                            <div style="font-size: 13px; color: #E65100;">Распределение тональности не определено</div>
                          </div>
                        `}
                        
                        ${item.all_tone_suggestions && item.all_tone_suggestions.length > 0 ? `
                          <div style="margin-top: 12px; font-size: 13px; color: var(--gray-700);">
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--primary);">Конкретные рекомендации по диалогам:</div>
                            ${item.all_tone_suggestions.map(suggestion => 
                              `<div style="padding: 4px 0; border-left: 2px solid var(--primary-light); margin-left: 8px; padding-left: 8px;">• ${suggestion}</div>`
                            ).join('')}
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              
              ${toneData.allRecommendations.length > 0 ? `
                <div class="tone-insights" style="margin-top: 24px; padding: 16px; background: var(--gray-50); border-radius: var(--radius-md); border-left: 4px solid var(--accent);">
                  <h5><i class="fas fa-lightbulb"></i> Все рекомендации по тону общения</h5>
                  <div style="margin-top: 8px; font-size: 14px; line-height: 1.5; max-height: 200px; overflow-y: auto;">
                    ${toneData.allRecommendations.map((rec, idx) => `
                      <div style="margin-bottom: 12px; padding-bottom: 12px; ${idx < toneData.allRecommendations.length - 1 ? 'border-bottom: 1px solid var(--gray-300);' : ''}">
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">
                          ${rec.date}
                        </div>
                        <div>${rec.recommendation}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
          
          UIModal.open('toneModal');
        }
      }
    };
  }
}

// ============================================================================
// ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
// ============================================================================
let app;

document.addEventListener('DOMContentLoaded', () => {
  app = new App();
  window.app = app;
});

// Закрытие модалок по клику на крестик
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('close-btn')) {
    const modal = e.target.closest('.modal');
    if (modal && (modal.id === 'addEmployeeModal' || modal.id === 'analysisModal' || modal.id === 'behaviorModal' || modal.id === 'toneModal')) {
      modal.style.display = 'none';
    }
  }
});
</script>
</body>
</html>
