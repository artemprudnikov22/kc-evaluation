<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Сервис ИИ-аналитики колл-центра | СЕВСТАР</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<!-- Вместо inline стилей подключим через link для чистоты -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
<div id="app"></div>

<!-- Подключаем модули -->
<script type="module">
// ============================================================================
// КОНФИГУРАЦИЯ
// ============================================================================
const CONFIG = {
  N8N_BASE_URL: 'https://n8n.decartus.team',
  UPLOAD_DIALOGS_URL: 'https://n8n.decartus.team/webhook/upload-dialogs',
  SYNC_EMPLOYEES_URL: 'https://n8n.decartus.team/webhook/sync-employees',
  GET_EMPLOYEES_URL: 'https://n8n.decartus.team/webhook/get-employees',
  GET_ANALYSIS_URL: 'https://n8n.decartus.team/webhook/get-analyzed-dialogs',
  AGGREGATION_TIME_WINDOW: 5 * 60 * 1000, // 5 минут
  MAX_FILE_SIZE_MB: 50,
  WARN_FILE_SIZE_MB: 10,
  SUPPORTED_FORMATS: '.txt,.json,.csv,.xlsx,.xls,.xml,.docx,.doc,.pdf'
};

// ============================================================================
// СТИЛИ (выносим в отдельную секцию)
// ============================================================================
const STYLES = `
:root {
  --primary: #642D90;
  --primary-light: #7A46A8;
  --primary-dark: #4A2170;
  --accent: #ECB144;
  --accent-light: #F3C97A;
  --accent-dark: #D59D3C;
  --dark: #353333;
  --light: #FFFFFF;
  --gray-50: #F8F9FA;
  --gray-100: #F1F3F5;
  --gray-200: #E9ECEF;
  --gray-300: #DEE2E6;
  --gray-400: #CED4DA;
  --gray-500: #ADB5BD;
  --gray-600: #868E96;
  --gray-700: #495057;
  --gray-800: #343A40;
  --gray-900: #212529;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-sm: 0 2px 8px rgba(100, 45, 144, 0.08);
  --shadow-md: 0 4px 16px rgba(100, 45, 144, 0.12);
  --shadow-lg: 0 8px 32px rgba(100, 45, 144, 0.16);
  --shadow-xl: 0 16px 48px rgba(100, 45, 144, 0.2);
  --transition-fast: 150ms ease;
  --transition-base: 250ms ease;
  --transition-slow: 350ms ease;
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-mono: 'SF Mono', Monaco, 'Cascadia Mono', 'Segoe UI Mono', monospace;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-sans);
  background: linear-gradient(135deg, #F8F5FC 0%, #F0EBF9 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  padding: 0;
}

/* Анимации */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(100, 45, 144, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(100, 45, 144, 0); }
  100% { box-shadow: 0 0 0 0 rgba(100, 45, 144, 0); }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Основной контейнер */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  animation: fadeIn var(--transition-slow);
}

/* Хедер */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
  padding: 20px;
  background: var(--light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  animation: slideInRight var(--transition-base);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  height: 56px;
  width: auto;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.title-section h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.title-section p {
  font-size: 14px;
  color: var(--gray-600);
  font-weight: 500;
}

.stats-section {
  display: flex;
  gap: 24px;
  align-items: center;
}

.stat-item {
  text-align: right;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-label {
  font-size: 12px;
  color: var(--gray-600);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Основной контент */
.main-content {
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;
}

/* Карточки сотрудников */
.employee-cards-container {
  background: var(--light);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-md);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-title i {
  color: var(--primary);
  font-size: 24px;
}

.add-employee-btn {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
  color: var(--dark);
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-sm);
}

.add-employee-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.add-employee-btn:active {
  transform: translateY(0);
}

.security-note {
  font-size: 13px;
  color: var(--gray-600);
  text-align: center;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  margin-bottom: 20px;
  border-left: 4px solid var(--accent);
}

.security-note span {
  color: #FF4757;
  font-weight: 600;
}

/* Карточка сотрудника */
.employee-card {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.employee-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-light);
}

.employee-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--primary-light));
  border-radius: var(--radius-sm) 0 0 var(--radius-sm);
}

.employee-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}

.employee-info h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 4px;
  cursor: pointer;
  display: inline-block;
  transition: color var(--transition-fast);
  padding-right: 24px;
  position: relative;
}

.employee-info h3:hover {
  color: var(--primary);
}

.employee-info h3::after {
  content: '✏️';
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.employee-info h3:hover::after {
  opacity: 1;
}

.employee-position {
  font-size: 14px;
  color: var(--gray-600);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.upload-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.upload-button {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--light);
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-sm);
}

.upload-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.upload-button:active {
  transform: translateY(0);
}

.file-input {
  display: none;
}

.file-types {
  font-size: 12px;
  color: var(--gray-500);
  text-align: right;
}

/* Статистика сотрудника */
.employee-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  padding: 16px;
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
}

.stat-card:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
}

.stat-card-title {
  font-size: 12px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-card-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
}

.stat-card-subtitle {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 4px;
}

/* Кнопка подробнее */
.details-toggle {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all var(--transition-base);
  width: 100%;
  justify-content: center;
  margin-top: 16px;
}

.details-toggle:hover {
  background: var(--primary);
  color: var(--light);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Подробная информация */
.employee-details {
  margin-top: 20px;
  padding: 20px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--accent);
  animation: fadeIn var(--transition-base);
}

.details-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.analysis-history {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.analysis-item {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 16px;
  border: 1px solid var(--gray-200);
  cursor: pointer;
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.analysis-item:hover {
  transform: translateX(4px);
  border-color: var(--primary-light);
  box-shadow: var(--shadow-sm);
}

.analysis-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 3px;
  background: var(--primary);
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.analysis-item:hover::before {
  opacity: 1;
}

.analysis-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.analysis-date {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.analysis-stats {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: var(--gray-600);
}

.analysis-stat {
  display: flex;
  align-items: center;
  gap: 4px;
}

.analysis-summary {
  font-size: 13px;
  color: var(--gray-700);
  line-height: 1.5;
}

.no-data {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
  font-style: italic;
}

.no-data i {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
  color: var(--gray-400);
}

/* Модальные окна */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.75);
  z-index: 1000;
  animation: fadeIn var(--transition-base);
  backdrop-filter: blur(8px);
}

.modal-content {
  background: var(--light);
  margin: 60px auto;
  padding: 0;
  border-radius: var(--radius-xl);
  max-width: 500px;
  width: 90%;
  box-shadow: var(--shadow-xl);
  animation: slideInRight var(--transition-base);
  overflow: hidden;
}

.modal-header {
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: var(--light);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
}

.close-btn {
  background: transparent;
  border: none;
  color: var(--light);
  font-size: 24px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background var(--transition-fast);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.modal-body {
  padding: 24px;
}

.modal-input-group {
  margin-bottom: 20px;
}

.modal-input-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.modal-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--gray-300);
  border-radius: var(--radius-md);
  font-size: 15px;
  font-family: var(--font-sans);
  transition: all var(--transition-fast);
  background: var(--light);
  color: var(--dark);
}

.modal-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(100, 45, 144, 0.1);
}

.modal-input::placeholder {
  color: var(--gray-400);
}

.modal-footer {
  padding: 20px 24px;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-200);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.modal-btn {
  padding: 10px 24px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  min-width: 100px;
}

.modal-btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: var(--light);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.modal-btn-secondary {
  background: var(--gray-200);
  color: var(--dark);
}

.modal-btn-secondary:hover {
  background: var(--gray-300);
}

/* Анализ модалка */
.analysis-modal-content {
  max-width: 800px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.analysis-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.analysis-header-info {
  padding: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 0.5%, var(--light) 5%);
  border-bottom: 1px solid var(--gray-200);
}

.analysis-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 8px;
}

.analysis-subtitle {
  font-size: 14px;
  color: var(--gray-600);
  display: flex;
  align-items: center;
  gap: 12px;
}

.analysis-batches {
  padding: 20px;
}

.batches-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--gray-200);
}

.batch-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.batch-item {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
}

.batch-item.expanded {
  box-shadow: var(--shadow-md);
}

.batch-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  background: var(--light);
}

.batch-header:hover {
  background: var(--gray-50);
}

.batch-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.batch-number {
  background: var(--primary);
  color: var(--light);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
}

.batch-details {
  font-size: 14px;
  color: var(--gray-700);
}

.batch-stats {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: var(--gray-600);
}

.batch-arrow {
  transition: transform var(--transition-base);
  color: var(--gray-500);
}

.batch-item.expanded .batch-arrow {
  transform: rotate(180deg);
}

.batch-content {
  padding: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height var(--transition-base);
  border-top: 1px solid transparent;
}

.batch-item.expanded .batch-content {
  max-height: 500px;
  padding: 20px;
  border-top-color: var(--gray-200);
}

.batch-analysis {
  background: var(--light);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 16px;
}

.batch-analysis h4 {
  font-size: 15px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.batch-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.batch-stat {
  text-align: center;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
}

.batch-stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
}

.batch-stat-label {
  font-size: 12px;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.batch-justification {
  font-size: 14px;
  color: var(--gray-700);
  line-height: 1.6;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--accent);
}

.batch-justification strong {
  color: var(--dark);
  font-weight: 700;
}

/* Лоадер */
.loader-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1999;
  backdrop-filter: blur(4px);
}

.loader {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--light);
  padding: 40px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  z-index: 2000;
  text-align: center;
  min-width: 300px;
  max-width: 400px;
  animation: pulse 2s infinite;
}

.spinner {
  border: 4px solid var(--gray-200);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

.loader-text {
  font-size: 16px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.loader-subtext {
  font-size: 14px;
  color: var(--gray-600);
  line-height: 1.5;
}

.loader-progress {
  width: 100%;
  height: 4px;
  background: var(--gray-200);
  border-radius: 2px;
  margin-top: 20px;
  overflow: hidden;
}

.loader-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
  width: 0%;
  transition: width var(--transition-base);
  border-radius: 2px;
}

/* Утилиты */
.icon {
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Адаптивность */
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }
  
  .header {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .logo-section {
    flex-direction: column;
    gap: 12px;
  }
  
  .stats-section {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .employee-header {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .upload-section {
    align-items: stretch;
  }
  
  .modal-content {
    width: 95%;
    margin: 20px auto;
  }
  
  .employee-stats {
    grid-template-columns: 1fr;
  }
}

/* Кастомный скроллбар */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}

/* Распределение по сложности */
.complexity-distribution {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  gap: 8px;
}

.complexity-level {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 8px;
  border-radius: var(--radius-sm);
  min-width: 40px;
  transition: all var(--transition-fast);
}

.complexity-level:hover {
  transform: translateY(-2px);
}

.level-1 {
  background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
  color: white;
}

.level-2 {
  background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
  color: white;
}

.level-3 {
  background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
  color: white;
}

.level-4 {
  background: linear-gradient(135deg, #F44336 0%, #E57373 100%);
  color: white;
}

.complexity-label {
  font-size: 12px;
  font-weight: 700;
  margin-bottom: 2px;
  opacity: 0.9;
}

.complexity-count {
  font-size: 14px;
  font-weight: 700;
}

/* Адаптивность для распределения сложности */
@media (max-width: 768px) {
  .complexity-distribution {
    gap: 4px;
  }
  
  .complexity-level {
    padding: 4px 6px;
    min-width: 36px;
  }
  
  .complexity-count {
    font-size: 12px;
  }
}
`;  //

// ============================================================================
// СОСТОЯНИЕ ПРИЛОЖЕНИЯ
// ============================================================================
class AppState {
  constructor() {
    this.employees = [];
    this.analysisData = {};
    this.aggregatedAnalysisData = {};
    this.nextEmployeeId = 106;
  }

  // Геттеры
  getEmployee(id) {
    return this.employees.find(e => e.id === id);
  }

  getAnalyses(employeeId) {
    return this.analysisData[employeeId] || [];
  }

  getAggregatedAnalyses(employeeId) {
    return this.aggregatedAnalysisData[employeeId] || [];
  }

  // Сеттеры
  setEmployees(employees) {
    this.employees = employees;
    if (employees.length > 0) {
      this.nextEmployeeId = Math.max(...employees.map(e => e.id)) + 1;
    }
  }

  setAnalysisData(data) {
    this.analysisData = data;
  }

  setAggregatedAnalysisData(data) {
    this.aggregatedAnalysisData = data;
  }

  // Обновление сотрудника
  updateEmployee(id, updates) {
    const index = this.employees.findIndex(e => e.id === id);
    if (index !== -1) {
      this.employees[index] = { ...this.employees[index], ...updates };
    }
  }

  // Добавление сотрудника
  addEmployee(employee) {
    employee.id = this.nextEmployeeId++;
    employee.expanded = false;
    this.employees.push(employee);
  }
}

// ============================================================================
// API СЛОЙ
// ============================================================================
class ApiService {
  static async loadEmployees() {
    try {
      const response = await fetch(CONFIG.GET_EMPLOYEES_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки сотрудников:', error);
      return [];
    }
  }

  static async loadAnalysisData() {
    try {
      const response = await fetch(CONFIG.GET_ANALYSIS_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки анализов:', error);
      return [];
    }
  }

  static async syncEmployees(employeesData) {
    try {
      const response = await fetch(CONFIG.SYNC_EMPLOYEES_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employees: employeesData })
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return true;
    } catch (error) {
      console.error('Ошибка синхронизации:', error);
      return false;
    }
  }

  static async uploadFile(formData) {
    try {
      const response = await fetch(CONFIG.UPLOAD_DIALOGS_URL, {
        method: 'POST',
        body: formData
      });
      if (!response.ok) throw new Error(`Ошибка сервера: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Ошибка загрузки файла:', error);
      throw error;
    }
  }
}

// ============================================================================
// УТИЛИТЫ
// ============================================================================
class Utils {
  static formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  static formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  }

  static formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  static groupAnalysesByTimeWindow(analyses, timeWindow = CONFIG.AGGREGATION_TIME_WINDOW) {
    if (!analyses || analyses.length === 0) return [];
    
    const sortedAnalyses = [...analyses].sort((a, b) => 
      new Date(a.analyzed_at) - new Date(b.analyzed_at)
    );
    
    const groups = [];
    let currentGroup = [];
    let groupStartTime = null;
    
    for (const analysis of sortedAnalyses) {
      const analysisTime = new Date(analysis.analyzed_at).getTime();
      
      if (!groupStartTime) {
        groupStartTime = analysisTime;
        currentGroup = [analysis];
      } else {
        const timeDiff = analysisTime - groupStartTime;
        
        if (timeDiff <= timeWindow) {
          currentGroup.push(analysis);
        } else {
          groups.push([...currentGroup]);
          groupStartTime = analysisTime;
          currentGroup = [analysis];
        }
      }
    }
    
    if (currentGroup.length > 0) {
      groups.push(currentGroup);
    }
    
    return groups;
  }

  static createAggregatedAnalyses(analysisData) {
    const aggregated = {};
    
    for (const [employeeId, analyses] of Object.entries(analysisData)) {
      if (!analyses || analyses.length === 0) continue;
      
      const groups = Utils.groupAnalysesByTimeWindow(analyses);
      
      aggregated[employeeId] = groups.map((group, index) => {
        const totalDialogs = group.reduce((sum, a) => sum + (parseInt(a.dialogs_count) || 0), 0);
        const totalComplexity = group.reduce((sum, a) => sum + (parseFloat(a.sum_complexity) || 0), 0);
        const totalIER = group.reduce((sum, a) => sum + (parseFloat(a.ier_coefficient) || 0), 0);
        
        const avgComplexity = totalDialogs > 0 ? (totalComplexity / totalDialogs).toFixed(2) : '0';
        const avgIER = group.length > 0 ? (totalIER / group.length).toFixed(2) : '0';
        
        const startTime = new Date(group[0].analyzed_at);
        const endTime = new Date(group[group.length - 1].analyzed_at);
        
        const dialogIds = group
          .map(a => a.dialog_ids || '')
          .filter(id => id)
          .join(', ');
        
        return {
          id: `agg_${employeeId}_${index}_${Date.now()}`,
          employee_id: parseInt(employeeId),
          start_time: startTime,
          end_time: endTime,
          total_dialogs: totalDialogs,
          batch_count: group.length,
          avg_complexity: avgComplexity,
          avg_ier: avgIER,
          total_ier: totalIER,
          dialog_ids: dialogIds,
          batches: group.map(batch => ({
            ...batch,
            parsed_ier: parseFloat(batch.ier_coefficient) || 0,
            parsed_complexity: parseFloat(batch.complexity_level) || 0,
            parsed_dialogs: parseInt(batch.dialogs_count) || 0
          })),
          formatted_date: Utils.formatDate(group[0].analyzed_at),
          formatted_time: `${Utils.formatTime(group[0].analyzed_at)} - ${Utils.formatTime(group[group.length - 1].analyzed_at)}`
        };
      });
    }
    
    return aggregated;
  }

  static calculateAverageIER(aggregatedAnalyses) {
    if (!aggregatedAnalyses || aggregatedAnalyses.length === 0) return 0;
    
    const validIERs = aggregatedAnalyses
      .map(a => parseFloat(a.avg_ier))
      .filter(ier => !isNaN(ier) && ier > 0);
      
    if (validIERs.length === 0) return 0;
    
    const sum = validIERs.reduce((acc, ier) => acc + ier, 0);
    return (sum / validIERs.length).toFixed(2);
  }
}

  // В классе Utils добавьте этот метод после существующих методов:
static calculateComplexityDistribution(analyses) {
  const distribution = { 1: 0, 2: 0, 3: 0, 4: 0 };
  
  if (!analyses || analyses.length === 0) return distribution;
  
  analyses.forEach(analysis => {
    if (analysis.complexity_level) {
      const complexity = parseFloat(analysis.complexity_level);
      if (complexity >= 1 && complexity <= 4) {
        const dialogsCount = parseInt(analysis.dialogs_count) || 0;
        // Если сложность - целое число, добавляем к соответствующему уровню
        if (Number.isInteger(complexity)) {
          distribution[complexity] += dialogsCount;
        } else {
          // Если сложность дробная, распределяем по ближайшим уровням
          const floor = Math.floor(complexity);
          const ceil = Math.ceil(complexity);
          const ratio = complexity - floor;
          
          distribution[floor] += Math.round(dialogsCount * (1 - ratio));
          if (ceil <= 4) {
            distribution[ceil] += Math.round(dialogsCount * ratio);
          }
        }
      }
    }
  });
  
  return distribution;
}

// ============================================================================
// КОМПОНЕНТЫ UI
// ============================================================================
class UILoader {
  static show(text = 'Загрузка...', subtext = '') {
    const loader = document.getElementById('loader');
    const backdrop = document.getElementById('loaderBackdrop');
    const loaderText = document.getElementById('loaderText');
    const loaderSubtext = document.getElementById('loaderSubtext');
    
    if (loaderText) loaderText.textContent = text;
    if (loaderSubtext) loaderSubtext.textContent = subtext;
    if (loader) loader.style.display = 'block';
    if (backdrop) backdrop.style.display = 'block';
  }

  static hide() {
    const loader = document.getElementById('loader');
    const backdrop = document.getElementById('loaderBackdrop');
    const progress = document.getElementById('loaderProgress');
    
    if (loader) loader.style.display = 'none';
    if (backdrop) backdrop.style.display = 'none';
    if (progress) progress.style.width = '0%';
  }

  static updateProgress(percent) {
    const progress = document.getElementById('loaderProgress');
    if (progress) progress.style.width = `${percent}%`;
  }
}

class UIModal {
  static open(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'block';
  }

  static close(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
  }

  static setupOutsideClick() {
    window.addEventListener('click', (event) => {
      const modals = ['addEmployeeModal', 'analysisModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal && event.target === modal) {
          UIModal.close(modalId);
        }
      });
    });
  }
}

// ============================================================================
// КОМПОНЕНТЫ ПРИЛОЖЕНИЯ
// ============================================================================
class HeaderComponent {
  static render(totalEmployees, totalAnalyses, totalDialogs) {
    return `
      <header class="header">
        <div class="logo-section">
          <img src="logo.png" alt="СЕВСТАР" class="logo">
          <div class="title-section">
            <h1>Сервис ИИ-аналитики колл-центра</h1>
            <p>Интеллектуальная аналитика и оценка качества обслуживания</p>
          </div>
        </div>
        <div class="stats-section">
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-users"></i> <span>${totalEmployees}</span></div>
            <div class="stat-label">Сотрудников</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-chart-line"></i> <span>${totalAnalyses}</span></div>
            <div class="stat-label">Анализов</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><i class="fas fa-microphone"></i> <span>${totalDialogs}</span></div>
            <div class="stat-label">Диалогов</div>
          </div>
        </div>
      </header>
    `;
  }
}

class EmployeeCardComponent {
  static render(employee, aggregatedAnalyses, app) {
    const avgIER = Utils.calculateAverageIER(aggregatedAnalyses);
    const lastIER = aggregatedAnalyses.length > 0 ? aggregatedAnalyses[aggregatedAnalyses.length - 1].avg_ier : '—';
    const lastDate = aggregatedAnalyses.length > 0 ? aggregatedAnalyses[aggregatedAnalyses.length - 1].formatted_date : '—';
    const totalDialogs = aggregatedAnalyses.reduce((sum, a) => sum + a.total_dialogs, 0);
    
    // Получаем все анализы сотрудника для подсчета распределения
    const allAnalyses = app.state.getAnalyses(employee.id);
    const complexityDistribution = Utils.calculateComplexityDistribution(allAnalyses);
    
    return `
      <div class="employee-card" data-employee-id="${employee.id}">
        <div class="employee-header">
          <div class="employee-info">
            <h3 onclick="app.handlers.editEmployeeName(${employee.id}, '${employee.name.replace(/'/g, "\\'")}')">
              ${employee.name}
            </h3>
            <div class="employee-position">
              <i class="fas fa-briefcase"></i>
              ${employee.position}
            </div>
          </div>
          
          <div class="upload-section">
            <label class="upload-button">
              <i class="fas fa-upload"></i>
              Загрузить диалоги
              <input type="file" class="file-input" 
                     accept="${CONFIG.SUPPORTED_FORMATS}" 
                     onchange="app.handlers.handleUpload(event, ${employee.id})">
            </label>
            <div class="file-types">TXT, JSON, CSV, Excel, Word, PDF</div>
          </div>
        </div>
        
        <div class="employee-stats">
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-chart-line"></i>
              Итоговый ИЭР
            </div>
            <div class="stat-card-value">${avgIER || '—'}</div>
            <div class="stat-card-subtitle">Средний коэффициент</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-clock"></i>
              Последний ИЭР
            </div>
            <div class="stat-card-value">${lastIER}</div>
            <div class="stat-card-subtitle">${lastDate}</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-layer-group"></i>
              Анализов
            </div>
            <div class="stat-card-value">${aggregatedAnalyses.length}</div>
            <div class="stat-card-subtitle">Агрегированных</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-comments"></i>
              Диалогов
            </div>
            <div class="stat-card-value">${totalDialogs}</div>
            <div class="stat-card-subtitle">Всего обработано</div>
          </div>
          
          <!-- Новая карточка для распределения сложности -->
          <div class="stat-card">
            <div class="stat-card-title">
              <i class="fas fa-signal"></i>
              Распределение по сложности
            </div>
            <div class="complexity-distribution">
              <div class="complexity-level level-1" title="Уровень 1 (Простые)">
                <span class="complexity-label">1</span>
                <span class="complexity-count">${complexityDistribution[1]}</span>
              </div>
              <div class="complexity-level level-2" title="Уровень 2 (Средние)">
                <span class="complexity-label">2</span>
                <span class="complexity-count">${complexityDistribution[2]}</span>
              </div>
              <div class="complexity-level level-3" title="Уровень 3 (Сложные)">
                <span class="complexity-label">3</span>
                <span class="complexity-count">${complexityDistribution[3]}</span>
              </div>
              <div class="complexity-level level-4" title="Уровень 4 (Очень сложные)">
                <span class="complexity-label">4</span>
                <span class="complexity-count">${complexityDistribution[4]}</span>
              </div>
            </div>
            <div class="stat-card-subtitle">Уровни сложности диалогов</div>
          </div>
        </div>
        
        <button class="details-toggle" onclick="app.handlers.toggleEmployeeDetails(${employee.id})">
          <i class="fas fa-${employee.expanded ? 'chevron-up' : 'chevron-down'}"></i>
          ${employee.expanded ? 'Скрыть детали' : 'Показать историю анализов'}
        </button>
        
        ${employee.expanded ? this.renderDetails(employee, aggregatedAnalyses) : ''}
      </div>
    `;
  }

  static renderDetails(employee, aggregatedAnalyses) {
    return `
      <div class="employee-details">
        <div class="details-title">
          <i class="fas fa-history"></i>
          История агрегированных анализов
        </div>
        
        ${aggregatedAnalyses.length > 0 ? this.renderAnalysisHistory(employee, aggregatedAnalyses) : this.renderNoData()}
      </div>
    `;
  }

  static renderAnalysisHistory(employee, aggregatedAnalyses) {
    const items = aggregatedAnalyses.map((agg, index) => `
      <div class="analysis-item" onclick="app.handlers.openAnalysisModal(${employee.id}, ${index})">
        <div class="analysis-header">
          <div class="analysis-date">
            <i class="fas fa-calendar"></i>
            ${agg.formatted_date}
          </div>
          <div class="analysis-stats">
            <div class="analysis-stat">
              <i class="fas fa-clock"></i>
              ${agg.formatted_time}
            </div>
            <div class="analysis-stat">
              <i class="fas fa-layer-group"></i>
              ${agg.batch_count} батчей
            </div>
          </div>
        </div>
        <div class="analysis-summary">
          <strong>Диалогов:</strong> ${agg.total_dialogs} • 
          <strong>Средний ИЭР:</strong> ${agg.avg_ier} • 
          <strong>Средняя сложность:</strong> ${agg.avg_complexity}
        </div>
      </div>
    `).join('');
    
    return `<div class="analysis-history">${items}</div>`;
  }

  static renderNoData() {
    return `
      <div class="no-data">
        <i class="fas fa-chart-line"></i>
        <p>Анализы отсутствуют. Загрузите диалоги для начала анализа.</p>
      </div>
    `;
  }
}

class AnalysisModalComponent {
  static render(employee, aggregatedAnalysis) {
    return `
      <div class="modal-content analysis-modal-content">
        <div class="modal-header">
          <h3>Анализ диалогов: ${employee.name}</h3>
          <button class="close-btn" onclick="UIModal.close('analysisModal')">&times;</button>
        </div>
        <div class="analysis-modal-body">
          <div class="analysis-header-info">
            <div class="analysis-title">Агрегированный анализ</div>
            <div class="analysis-subtitle">
              <i class="fas fa-calendar-alt"></i>
              <span>${aggregatedAnalysis.formatted_date}</span>
              <i class="fas fa-clock"></i>
              <span>${aggregatedAnalysis.formatted_time}</span>
            </div>
          </div>
          
          <div class="analysis-batches">
            <div class="batches-title">
              <i class="fas fa-layer-group"></i>
              Батчи анализа (${aggregatedAnalysis.batch_count})
            </div>
            <div class="batch-list">
              ${aggregatedAnalysis.batches.map((batch, index) => this.renderBatch(batch, index, aggregatedAnalysis.employee_id)).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  static renderBatch(batch, index, employeeId) {
    const batchTime = Utils.formatTime(batch.analyzed_at);
    
    return `
      <div class="batch-item" id="batch-${employeeId}-${index}">
        <div class="batch-header" onclick="app.handlers.toggleBatchDetails(${employeeId}, ${index})">
          <div class="batch-info">
            <div class="batch-number">${index + 1}</div>
            <div class="batch-details">
              Батч от ${batchTime} • ${batch.dialogs_count} диалогов
            </div>
          </div>
          <div class="batch-stats">
            <div class="batch-stat">
              <i class="fas fa-chart-line"></i>
              <span>ИЭР: ${batch.ier_coefficient}</span>
            </div>
            <div class="batch-stat">
              <i class="fas fa-layer-group"></i>
              <span>Сложность: ${batch.complexity_level}</span>
            </div>
          </div>
          <div class="batch-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="batch-content">
          <div class="batch-analysis">
            <h4><i class="fas fa-chart-bar"></i> Статистика батча</h4>
            <div class="batch-stats-grid">
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.dialogs_count}</div>
                <div class="batch-stat-label">Диалогов</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.ier_coefficient}</div>
                <div class="batch-stat-label">ИЭР</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.complexity_level}</div>
                <div class="batch-stat-label">Сложность</div>
              </div>
              <div class="batch-stat">
                <div class="batch-stat-value">${batch.parsed_count || 0}</div>
                <div class="batch-stat-label">Обработано</div>
              </div>
            </div>
            
            <h4><i class="fas fa-comment-alt"></i> Обоснование</h4>
            <div class="batch-justification">${batch.justification || 'Обоснование отсутствует'}</div>
          </div>
        </div>
      </div>
    `;
  }
}

// ============================================================================
// ГЛАВНОЕ ПРИЛОЖЕНИЕ
// ============================================================================
class App {
  constructor() {
    this.state = new AppState();
    this.handlers = this.createHandlers();
    this.init();
  }

  async init() {
    // Добавляем стили
    this.addStyles();
    
    // Инициализируем UI
    this.renderApp();
    
    // Загружаем данные
    await this.loadData();
    
    // Обновляем UI
    this.updateUI();
  }

  addStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = STYLES;
    document.head.appendChild(styleElement);
  }

  renderApp() {
    const appContainer = document.getElementById('app');
    appContainer.innerHTML = `
      <div class="container">
        <!-- Хедер будет загружен динамически -->
        <div id="header"></div>
        
        <main class="main-content">
          <div class="employee-cards-container">
            <div class="section-header">
              <div class="section-title">
                <i class="fas fa-users-cog"></i>
                <span>Отдел колл-центра</span>
              </div>
              <button class="add-employee-btn" onclick="app.handlers.openAddEmployeeModal()">
                <i class="fas fa-user-plus"></i>
                Добавить сотрудника
              </button>
            </div>
            
            <div class="security-note">
              * В целях сохранности данных, для удаления сотрудника обратитесь к <span>администратору</span>.
            </div>
            
            <div id="content"></div>
          </div>
        </main>
      </div>
      
      <!-- Лоадер -->
      <div class="loader-backdrop" id="loaderBackdrop"></div>
      <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">Загрузка и обработка файла...</div>
        <div class="loader-subtext" id="loaderSubtext"></div>
        <div class="loader-progress">
          <div class="loader-progress-bar" id="loaderProgress"></div>
        </div>
      </div>
      
      <!-- Модальные окна -->
      ${this.renderAddEmployeeModal()}
      <div id="analysisModal" class="modal"></div>
    `;
    
    UIModal.setupOutsideClick();
  }

  renderAddEmployeeModal() {
    return `
      <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Добавить сотрудника</h3>
            <button class="close-btn" onclick="UIModal.close('addEmployeeModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="modal-input-group">
              <label for="newEmpName">ФИО сотрудника</label>
              <input type="text" id="newEmpName" class="modal-input" placeholder="Иванов Иван Иванович">
            </div>
            <div class="modal-input-group">
              <label for="newEmpPosition">Должность</label>
              <input type="text" id="newEmpPosition" class="modal-input" placeholder="Оператор колл-центра">
            </div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="UIModal.close('addEmployeeModal')">Отмена</button>
            <button class="modal-btn modal-btn-primary" onclick="app.handlers.saveNewEmployee()">Сохранить</button>
          </div>
        </div>
      </div>
    `;
  }

  async loadData() {
    UILoader.show('Загрузка данных...', 'Подключение к сервису AI-аналитики');
    
    try {
      // Загружаем сотрудников
      const employeesData = await ApiService.loadEmployees();
      if (Array.isArray(employeesData) && employeesData.length > 0) {
        const employees = employeesData.map(row => ({
          id: parseInt(row.employee_id),
          name: row.name,
          position: row.position,
          expanded: false
        }));
        this.state.setEmployees(employees);
      }

      // Загружаем анализы
      const analysisRows = await ApiService.loadAnalysisData();
      const analysisData = {};
      
      if (Array.isArray(analysisRows)) {
        analysisRows.forEach(row => {
          const empId = parseInt(row.employee_id);
          if (!analysisData[empId]) analysisData[empId] = [];
          
          analysisData[empId].push({
            date: row.analyzed_at,
            dialogs_count: row.dialogs_count,
            dialog_ids: row.dialog_ids || '',
            complexity_level: row.complexity_level,
            ier_coefficient: row.ier_coefficient,
            justification: row.justification,
            sum_complexity: row.sum_complexity,
            batch_summary: row.batch_summary,
            parsed_count: row.parsed_count,
            analyzed_at: row.analyzed_at
          });
        });
      }
      
      this.state.setAnalysisData(analysisData);
      
      // Создаем агрегированные анализы
      const aggregated = Utils.createAggregatedAnalyses(analysisData);
      this.state.setAggregatedAnalysisData(aggregated);
      
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
    } finally {
      UILoader.hide();
    }
  }

  updateUI() {
    // Обновляем статистику
    this.updateStats();
    
    // Рендерим сотрудников
    this.renderEmployees();
  }

  updateStats() {
    const totalEmployees = this.state.employees.length;
    
    let totalAnalyses = 0;
    let totalDialogs = 0;
    
    Object.values(this.state.analysisData).forEach(analyses => {
      totalAnalyses += analyses.length;
      analyses.forEach(a => {
        totalDialogs += parseInt(a.dialogs_count) || 0;
      });
    });
    
    // Обновляем хедер
    const headerContainer = document.getElementById('header');
    if (headerContainer) {
      headerContainer.innerHTML = HeaderComponent.render(totalEmployees, totalAnalyses, totalDialogs);
    }
  }

  renderEmployees() {
    const contentContainer = document.getElementById('content');
    
    if (this.state.employees.length === 0) {
      contentContainer.innerHTML = `
        <div class="no-data">
          <i class="fas fa-users-slash"></i>
          <h3>Сотрудники не найдены</h3>
          <p>Добавьте первого сотрудника, нажав кнопку "Добавить сотрудника"</p>
        </div>
      `;
      return;
    }
    
    const cards = this.state.employees.map(employee => {
  const aggregatedAnalyses = this.state.getAggregatedAnalyses(employee.id);
  return EmployeeCardComponent.render(employee, aggregatedAnalyses, this);
}).join('');
    
    contentContainer.innerHTML = cards;
  }

  createHandlers() {
    return {
      // Обработка загрузки файла
      handleUpload: async (event, employeeId) => {
        const file = event.target.files[0];
        if (!file) return;

        const employee = this.state.getEmployee(employeeId);
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);

        // Проверка размера файла
        if (file.size > CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024) {
          alert(`Файл слишком большой. Максимальный размер: ${CONFIG.MAX_FILE_SIZE_MB} МБ`);
          event.target.value = '';
          return;
        }

        // Подтверждение для больших файлов
        if (file.size > CONFIG.WARN_FILE_SIZE_MB * 1024 * 1024) {
          const confirmUpload = confirm(
            `Файл довольно большой (${fileSizeMB} МБ). Обработка может занять несколько минут.\n\nПродолжить загрузку?`
          );
          
          if (!confirmUpload) {
            event.target.value = '';
            return;
          }
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('employeeId', employeeId);
        formData.append('employeeName', employee.name);

        UILoader.show('Загрузка файла...', `Файл: ${file.name}\nРазмер: ${fileSizeMB} МБ`);

        try {
          const result = await ApiService.uploadFile(formData);
          UILoader.hide();
          
          alert(`✅ Файл успешно обработан!\n\nСотрудник: ${employee.name}\nДиалогов: ${result.total || result.processed || 'N/A'}`);
          
          // Обновляем данные
          UILoader.show('Обновление данных...');
          await this.loadData();
          this.updateUI();
          UILoader.hide();
          
        } catch (error) {
          UILoader.hide();
          alert(`❌ Ошибка при загрузке файла:\n\n${error.message}\n\nПроверьте подключение к интернету и попробуйте снова.`);
        }

        event.target.value = '';
      },

      // Редактирование имени сотрудника
      editEmployeeName: async (employeeId, currentName) => {
        const employee = this.state.getEmployee(employeeId);
        if (!employee) return;

        const newName = prompt('Введите новое имя сотрудника:', currentName);
        if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
          this.state.updateEmployee(employeeId, { name: newName.trim() });
          this.updateUI();
          
          // Синхронизируем с БД
          const employeesData = this.state.employees.map(emp => ({
            id: emp.id,
            name: emp.name,
            position: emp.position,
            summary: {
              final_score: 0,
              final_grade: 'N/A',
              last_score: 0,
              last_grade: 'N/A',
              last_review_date: ''
            },
            details: {
              data: {
                grade_history: [],
                review_details: []
              }
            }
          }));
          
          await ApiService.syncEmployees(employeesData);
        }
      },

      // Переключение деталей сотрудника
      toggleEmployeeDetails: (employeeId) => {
        const employee = this.state.getEmployee(employeeId);
        if (employee) {
          this.state.updateEmployee(employeeId, { expanded: !employee.expanded });
          this.renderEmployees();
        }
      },

      // Открытие модального окна с анализом
      openAnalysisModal: (employeeId, analysisIndex) => {
        const employee = this.state.getEmployee(employeeId);
        const aggregatedAnalyses = this.state.getAggregatedAnalyses(employeeId);
        
        if (employee && aggregatedAnalyses[analysisIndex]) {
          const modalContainer = document.getElementById('analysisModal');
          modalContainer.innerHTML = AnalysisModalComponent.render(employee, aggregatedAnalyses[analysisIndex]);
          UIModal.open('analysisModal');
        }
      },

      // Переключение деталей батча
      toggleBatchDetails: (employeeId, batchIndex) => {
        const batchElement = document.getElementById(`batch-${employeeId}-${batchIndex}`);
        if (batchElement) {
          batchElement.classList.toggle('expanded');
        }
      },

      // Модальные окна
      openAddEmployeeModal: () => {
        UIModal.open('addEmployeeModal');
        document.getElementById('newEmpName').value = '';
        document.getElementById('newEmpPosition').value = '';
        document.getElementById('newEmpName').focus();
      },

      saveNewEmployee: async () => {
        const name = document.getElementById('newEmpName').value.trim();
        const position = document.getElementById('newEmpPosition').value.trim();

        if (!name || !position) {
          alert('Пожалуйста, заполните все поля');
          return;
        }

        this.state.addEmployee({ name, position });
        UIModal.close('addEmployeeModal');
        this.updateUI();

        // Синхронизируем с БД
        const employeesData = this.state.employees.map(emp => ({
          id: emp.id,
          name: emp.name,
          position: emp.position,
          summary: {
            final_score: 0,
            final_grade: 'N/A',
            last_score: 0,
            last_grade: 'N/A',
            last_review_date: ''
          },
          details: {
            data: {
              grade_history: [],
              review_details: []
            }
          }
        }));
        
        await ApiService.syncEmployees(employeesData);
      }
    };
  }
}

// Фикс всех крестиков модалок
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('close-btn')) {
    const modal = e.target.closest('.modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
});  
// ============================================================================
// ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
// ============================================================================
let app;

document.addEventListener('DOMContentLoaded', () => {
  app = new App();
  window.app = app; // Делаем доступным глобально для обработчиков событий
});
</script>
</body>
</html>






